<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.101.0"><link rel=alternate type=application/rss+xml href=https://azure.github.io/fta-kusto100knocks/docs/advanced/index.xml><meta name=robots content="index, follow"><link rel="shortcut icon" href=/fta-kusto100knocks/favicons/favicon.ico><link rel=apple-touch-icon href=/fta-kusto100knocks/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/fta-kusto100knocks/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/fta-kusto100knocks/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/fta-kusto100knocks/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/fta-kusto100knocks/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/fta-kusto100knocks/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/fta-kusto100knocks/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/fta-kusto100knocks/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/fta-kusto100knocks/favicons/android-192x192.png sizes=192x192><title>Advanced | KUSTO 100+ knocks</title><meta name=description content="Learn the most commonly used queries for Azure services."><meta property="og:title" content="Advanced"><meta property="og:description" content="Learn the most commonly used queries for Azure services."><meta property="og:type" content="website"><meta property="og:url" content="https://azure.github.io/fta-kusto100knocks/docs/advanced/"><meta itemprop=name content="Advanced"><meta itemprop=description content="Learn the most commonly used queries for Azure services."><meta name=twitter:card content="summary"><meta name=twitter:title content="Advanced"><meta name=twitter:description content="Learn the most commonly used queries for Azure services."><link rel=preload href=/fta-kusto100knocks/scss/main.min.e42fbc313eb1919891fde4bb3bfbacc710b8890c78adce84a179ab0f4ff8977d.css as=style><link href=/fta-kusto100knocks/scss/main.min.e42fbc313eb1919891fde4bb3bfbacc710b8890c78adce84a179ab0f4ff8977d.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Q7J6SYY1S8"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Q7J6SYY1S8",{anonymize_ip:!1})}</script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/fta-kusto100knocks/><span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class=font-weight-bold>KUSTO 100+ knocks</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/fta-kusto100knocks/docs/><span class=active>Documents</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/fta-kusto100knocks/ja/docs/advanced/>日本語</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/fta-kusto100knocks/ja/docs/advanced/>日本語</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-fta-kusto100knocksdocs-li><a href=/fta-kusto100knocks/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-fta-kusto100knocksdocs><span>Documents</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-fta-kusto100knocksdocsbasic-li><a href=/fta-kusto100knocks/docs/basic/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-fta-kusto100knocksdocsbasic><span>Basic</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-fta-kusto100knocksdocsadvanced-li><a href=/fta-kusto100knocks/docs/advanced/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__section" id=m-fta-kusto100knocksdocsadvanced><span class=td-sidebar-nav-active-item>Advanced</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-fta-kusto100knocksdocsportal-li><a href=https://portal.azure.com/#blade/Microsoft_Azure_Monitoring_Logs/DemoLogsBlade target=_blank rel=noopener class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-fta-kusto100knocksdocsportal><span>Try it in the demo workspace🔎</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/Azure/fta-kusto100knocks//tree/main/content/en/docs/Advanced/_index.md class=td-page-meta--view target=_blank rel=noopener><i class="fa fa-file-alt fa-fw"></i> View page source</a>
<a href=https://github.com/Azure/fta-kusto100knocks//edit/main/content/en/docs/Advanced/_index.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/Azure/fta-kusto100knocks//new/main/content/en/docs/Advanced/_index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/Azure/fta-kusto100knocks//issues/new?title=Advanced" class=td-page-meta--issue target=_blank rel=noopener><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/Azure/fta-kusto100knocks//issues/new class=td-page-meta--project-issue target=_blank rel=noopener><i class="fas fa-tasks fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><ul><li><a href=#network>Network</a></li><li><a href=#compute>Compute</a></li><li><a href=#data>Data</a></li><li><a href=#avd>AVD</a></li><li><a href=#application-insights>Application Insights</a></li><li><a href=#security>Security</a></li><li><a href=#resource-graph>Resource Graph</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=https://azure.github.io/fta-kusto100knocks/docs/>Documents</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://azure.github.io/fta-kusto100knocks/docs/advanced/>Advanced</a></li></ol></nav><div class=td-content><h1>Advanced</h1><div class=lead>Learn the most commonly used queries for Azure services.</div><header class=article-meta></header><h3 id=network>Network</h3><div><details><summary>Review Azure Firewall Application Rules denied by firewall</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>q1</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>view</span>() {
</span></span><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;AzureFirewallApplicationRule&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#a6e22e>contains</span> <span style=color:#e6db74>&#34; to &#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>kind</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>regex</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>Protocol</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34; request from &#34;</span> <span style=color:#a6e22e>SourceIP</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#a6e22e>SourcePort</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34; to &#34;</span> <span style=color:#a6e22e>TargetURL</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#a6e22e>targetPort</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34;. Action: &#34;</span> <span style=color:#a6e22e>Action</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34;.\sN&#34;</span> <span style=color:#a6e22e>Reason</span>
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>q2</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>view</span>() {
</span></span><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;AzureFirewallApplicationRule&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>contains</span> <span style=color:#e6db74>&#34; to &#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>kind</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>regex</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>Protocol</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34; request from &#34;</span> <span style=color:#a6e22e>SourceIP</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#a6e22e>SourcePort</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34;. Action: &#34;</span> <span style=color:#a6e22e>Action</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34;. Reason:&#34;</span> <span style=color:#a6e22e>Reason</span>
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#a6e22e>union</span> <span style=color:#a6e22e>withsource</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;temptable&#34;</span> <span style=color:#a6e22e>q1</span>,<span style=color:#a6e22e>q2</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>SourceIP</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;xx.xx.xx.xx&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TargetURL</span>, <span style=color:#a6e22e>targetPort</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//#| summarize count() by FQDN | order by count_ desc 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>count_</span> <span style=color:#a6e22e>desc</span> 
</span></span></code></pre></div></p><p>Description :<br>Review Azure Firewall Application Rules denied by firewall</p></details></div><div><details><summary>List Azure Firewall denied connections (Network Rule) for certain IP and port (modify the query as required)</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;AzureFirewallNetworkRule&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>Protocol</span> <span style=color:#e6db74>&#34; request from &#34;</span> <span style=color:#a6e22e>SourceIP</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#a6e22e>SourcePortInt</span><span style=color:#f92672>:</span><span style=color:#66d9ef>int</span> <span style=color:#e6db74>&#34; to &#34;</span> <span style=color:#a6e22e>TargetIP</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#a6e22e>TargetPortInt</span><span style=color:#f92672>:</span><span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#66d9ef>with</span> <span style=color:#f92672>*</span> <span style=color:#e6db74>&#34;. Action: &#34;</span> <span style=color:#a6e22e>Action1a</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#66d9ef>with</span> <span style=color:#f92672>*</span> <span style=color:#e6db74>&#34;was &#34;</span> <span style=color:#a6e22e>Action1b</span> <span style=color:#e6db74>&#34; to &#34;</span> <span style=color:#a6e22e>NatDestination</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>Protocol2</span> <span style=color:#e6db74>&#34; request from &#34;</span> <span style=color:#a6e22e>SourceIP2</span> <span style=color:#e6db74>&#34; to &#34;</span> <span style=color:#a6e22e>TargetIP2</span> <span style=color:#e6db74>&#34;. Action:&#34;</span> <span style=color:#a6e22e>Action2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>SourcePort</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>SourcePortInt</span>),<span style=color:#a6e22e>TargetPort</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>TargetPortInt</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>Action</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>case</span>(<span style=color:#a6e22e>Action1a</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#66d9ef>case</span>(<span style=color:#a6e22e>Action1b</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#a6e22e>Action2</span>,<span style=color:#a6e22e>Action1b</span>), <span style=color:#a6e22e>Action1a</span>),<span style=color:#a6e22e>Protocol</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>case</span>(<span style=color:#a6e22e>Protocol</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>Protocol2</span>, <span style=color:#a6e22e>Protocol</span>),<span style=color:#a6e22e>SourceIP</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>case</span>(<span style=color:#a6e22e>SourceIP</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>SourceIP2</span>, <span style=color:#a6e22e>SourceIP</span>),<span style=color:#a6e22e>TargetIP</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>case</span>(<span style=color:#a6e22e>TargetIP</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>TargetIP2</span>, <span style=color:#a6e22e>TargetIP</span>),<span style=color:#a6e22e>SourcePort</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>case</span>(<span style=color:#a6e22e>SourcePort</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;N/A&#34;</span>, <span style=color:#a6e22e>SourcePort</span>),<span style=color:#a6e22e>TargetPort</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>case</span>(<span style=color:#a6e22e>TargetPort</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;N/A&#34;</span>, <span style=color:#a6e22e>TargetPort</span>),<span style=color:#a6e22e>NatDestination</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>case</span>(<span style=color:#a6e22e>NatDestination</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;N/A&#34;</span>, <span style=color:#a6e22e>NatDestination</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>TimeGenerated</span>,<span style=color:#a6e22e>Protocol</span>, <span style=color:#a6e22e>SourceIP</span>,<span style=color:#a6e22e>SourcePort</span>,<span style=color:#a6e22e>TargetIP</span>,<span style=color:#a6e22e>TargetPort</span>,<span style=color:#a6e22e>Action</span>, <span style=color:#a6e22e>NatDestination</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>SourceIP</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;10.1.4.25&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>TargetPort</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>22</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>Action</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Deny&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>desc</span> 
</span></span></code></pre></div></p><p>Description :<br>List Azure Firewall denied connections (Network Rule) for certain IP and port (modify the query as required)</p></details></div><div><details><summary>NSG Flowlog - Display flows based on Source IP (modify the query as required)</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>  <span style=color:#a6e22e>AzureNetworkAnalytics_CL</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>SubType_s</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;FlowLog&#34;</span> 
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>SrcIP_s</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ipaddress&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>DestIP_s</span>, <span style=color:#a6e22e>DestPort_d</span>
</span></span></code></pre></div></p><p>Description :<br>NSG Flowlog - Display flows based on Source IP (display destination port and IP). Replace the ip address as required.</p></details></div><div><details><summary>NSG Flowlog - Display flows based on Target IP (display source port and IP)</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureNetworkAnalytics_CL</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>SubType_s</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;FlowLog&#34;</span> 
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>DestIP_s</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ipaddress&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>SrcIP_s</span>, <span style=color:#a6e22e>DestPort_d</span>
</span></span></code></pre></div></p><p>Description :<br>NSG Flowlog - Display flows based on Target IP (display source port and IP)</p></details></div><div><details><summary>Investigate top 3 incoming processes based on Bytes Recieved</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMConnection</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Computer</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;computername&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Received</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesReceived</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>ProcessName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>3</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Received</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>Description :<br>Investigate top 3 incoming processes based on Bytes Recieved</p></details></div><div><details><summary>Investigate top 3 outgoing processes based on Bytes Sent</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMConnection</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Computer</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;computername&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Sent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesSent</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>ProcessName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>3</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Sent</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>Description :<br>Investigate top 3 outgoing processes based on Bytes Sent</p></details></div><div><details><summary>Investigate top 3 processes based on Bytes Received and Sent</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMConnection</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Computer</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;computername&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Received</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesReceived</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>), <span style=color:#a6e22e>Sent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesSent</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>ProcessName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>TotalMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Received</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>Sent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>SentMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Sent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>ReceivedMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Received</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>ProcessName</span>, <span style=color:#a6e22e>SentMb</span>, <span style=color:#a6e22e>ReceivedMb</span>, <span style=color:#a6e22e>TotalMb</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>3</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TotalMb</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>Description :<br>Investigate top 3 processes based on Bytes Received and Sent</p></details></div><div><details><summary>Graph showing network Sent/sec and Received/sec, 30 minute average for the timeframe</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Perf</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Computer</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;computername&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ObjectName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Network Adapter&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>InstanceName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Microsoft Hyper-V Network Adapter _2&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>CounterValue</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>CounterName</span>, <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>30</span><span style=color:#a6e22e>min</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>desc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span> 
</span></span></code></pre></div></p><p>Description :<br>Graph showing network Sent/sec and Received/sec, 30 minute average for the timeframe</p></details></div><div><details><summary>Investigate top 3 communication partners based on Bytes Received and Bytes Sent</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMConnection</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Computer</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;computername&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>DNS</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>parse_json</span>(<span style=color:#a6e22e>RemoteDnsQuestions</span>)[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Received</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesReceived</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>), <span style=color:#a6e22e>Sent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesSent</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>DestinationIp</span>, <span style=color:#a6e22e>DNS</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>TotalMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Received</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>Sent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>SentMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Sent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>ReceivedMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Received</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>DestinationIp</span>, <span style=color:#a6e22e>SentMb</span>, <span style=color:#a6e22e>ReceivedMb</span>, <span style=color:#a6e22e>TotalMb</span>, <span style=color:#a6e22e>DNS</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>3</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TotalMb</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>Description :<br>Investigate top 3 communication partners based on Bytes Received and Bytes Sent</p></details></div><div><details><summary>Investigate top 10 computers with most inbound and outbound communications events</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMConnection</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Events</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Events</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>Description :<br>Investigate top 10 computers with most inbound and outbound communications events</p></details></div><div><details><summary>Investigate top 10 ports with most communications events</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMConnection</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Events</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>DestinationPort</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Events</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>Description :<br>Investigate top 10 ports with most communications events</p></details></div><div><details><summary>Investigate top 3 communication ports based on Bytes Received and Bytes Sent</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMConnection</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Received</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesReceived</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>), <span style=color:#a6e22e>Sent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesSent</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>DestinationPort</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>TotalMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Received</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>Sent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>SentMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Sent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>ReceivedMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Received</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>DestinationPort</span>, <span style=color:#a6e22e>SentMb</span>, <span style=color:#a6e22e>ReceivedMb</span>, <span style=color:#a6e22e>TotalMb</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>3</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TotalMb</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>Description :<br>Investigate top 3 communication ports based on Bytes Received and Bytes Sent</p></details></div><div><details><summary>Investigate top 3 communication ports based on ProcessName</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMConnection</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Received</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesReceived</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>), <span style=color:#a6e22e>Sent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesSent</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>ProcessName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>TotalMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Received</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>Sent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>SentMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Sent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>ReceivedMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Received</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>ProcessName</span>, <span style=color:#a6e22e>SentMb</span>, <span style=color:#a6e22e>ReceivedMb</span>, <span style=color:#a6e22e>TotalMb</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>3</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TotalMb</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>Description :<br>Investigate top 3 communication ports based on ProcessName</p></details></div><h3 id=compute>Compute</h3><div><details><summary>Get the last heartbeat per computer</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Heartbeat</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>LastHeartBeat</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>arg_max</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#f92672>*</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>
</span></span></code></pre></div></p><p>Description :<br>If the Microsoft Monitoring agent is deployed to a computer, it sends a heart beat every minute. With this query, you can see the last heart beat sent by each computer.</p></details></div><div><details><summary>See computers that have not sent a heart beat in 5 minutes</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Heartbeat</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>LastHeartBeat</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>arg_max</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#f92672>*</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>LastHeartBeat</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span></code></pre></div></p><p>Description :<br>See computers that have not sent a heart beat in 5 minutes</p></details></div><div><details><summary>See the % Free Disk Space for all computers aggregated over the last 4 hours</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>InsightsMetrics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>4</span><span style=color:#a6e22e>h</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Namespace</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;LogicalDisk&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;FreeSpacePercentage&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>DiskInstance</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>parse_json</span>(<span style=color:#a6e22e>Tags</span>).[<span style=color:#e6db74>&#34;vm.azm.ms/mountId&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>DiskFreeSpace</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>Val</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>4</span><span style=color:#a6e22e>h</span>), <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>DiskInstance</span>
</span></span></code></pre></div></p><p>Description :<br>When using VM Insights, all performance counters are collected into the Insight Metrics table. This query shows the % Free space across all disks aggregated for the last 4 hours</p></details></div><div><details><summary>Show latest status from Update Management for all computers</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>UpdateSummary</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>arg_max</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#f92672>*</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>LastUpdateApplied</span>, <span style=color:#a6e22e>OldestMissingSecurityUpdateInDays</span>, <span style=color:#a6e22e>WindowsUpdateSetting</span>, <span style=color:#a6e22e>SecurityUpdatesMissing</span>, <span style=color:#a6e22e>OtherUpdatesMissing</span>, <span style=color:#a6e22e>RestartPending</span>
</span></span></code></pre></div></p><p>Description :<br>If using Update Management, you can use this query to show the latest status for each computer, including how many updates are missing for each computer</p></details></div><div><details><summary>Show the status of each Update job for the last 7 days</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>UpdateRunProgress</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>7</span><span style=color:#a6e22e>d</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Failed</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>countif</span>(<span style=color:#a6e22e>InstallationStatus</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Failed&#34;</span>), <span style=color:#a6e22e>FailedtoStart</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>countif</span>(<span style=color:#a6e22e>InstallationStatus</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;FailedtoStart&#34;</span>), <span style=color:#a6e22e>InProgress</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>countif</span>(<span style=color:#a6e22e>InstallationStatus</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;InProgress&#34;</span>), <span style=color:#a6e22e>Succeeded</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>countif</span>(<span style=color:#a6e22e>InstallationStatus</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Succeeded&#34;</span>), <span style=color:#a6e22e>NotIncluded</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>countif</span>(<span style=color:#a6e22e>InstallationStatus</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;NotIncluded&#34;</span>), <span style=color:#a6e22e>NotStarted</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>countif</span>(<span style=color:#a6e22e>InstallationStatus</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;NotStarted&#34;</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>UpdateRunName</span>
</span></span></code></pre></div></p><p>Description :<br>Use this query to see the number of updates in each status for each update job for the last 7 days</p></details></div><h3 id=data>Data</h3><div><details><summary>Azure SQL Database: Show the categories that can be output by SQL Database</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Category</span>
</span></span></code></pre></div></p><p>Description :<br>In the &ldquo;Database Wait Statistics&rdquo; category, you can see the details of the waiting time of internal resources that occurred in the database within the specified range period. In the &ldquo;Query Store Wait Statistics&rdquo; category, you can see the details of the waiting time of internal resources generated in the database from the entire information stored in the query store. You can see the errors that occurred in the &ldquo;Errors&rdquo; category.</p></details></div><div><details><summary>Azure SQL Database: View resource wait time details in a pie chart</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;DatabaseWaitStatistics&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>delta_wait_time_ms_d</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>wait_type_s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>sort</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>sum_delta_wait_time_ms_d</span> <span style=color:#a6e22e>desc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>piechart</span> 
</span></span></code></pre></div></p><p>Description :<br>By focusing on resources with high latency, you can discover clues to improve database performance.</p></details></div><div><details><summary>Azure SQL Database: Display the details of the resource wait count in a pie chart</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;DatabaseWaitStatistics&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>delta_waiting_tasks_count_d</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>wait_type_s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>sort</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>sum_delta_waiting_tasks_count_d</span> <span style=color:#a6e22e>desc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>piechart</span> 
</span></span></code></pre></div></p><p>Description :<br>By focusing on resources with high wait times, you can find clues to improve database performance.</p></details></div><div><details><summary>Azure SQL Database: View the details of the resource wait time information stored in the query store in a pie chart</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;QueryStoreWaitStatistics&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>total_query_wait_time_ms_d</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>wait_category_s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>sort</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>sum_total_query_wait_time_ms_d</span> <span style=color:#a6e22e>desc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>piechart</span> 
</span></span></code></pre></div></p><p>Description :<br>By focusing on resources with high latency, you can discover clues to improve database performance. By default, one month&rsquo;s worth of information is stored in the query store, so you can check in a wider range.</p></details></div><div><details><summary>Azure SQL Database: View errors that occurred in SQL Database</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;Errors&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#a6e22e>error_number_d</span>, <span style=color:#a6e22e>Severity</span>, <span style=color:#a6e22e>state_d</span>, <span style=color:#a6e22e>Message</span>
</span></span></code></pre></div></p><p>Description :<br>Understanding the errors that occur in the database will help resolve the actual failures and prevent potential failures.</p></details></div><div><details><summary>Azure SQL Database: Display the number of errors that occurred in SQL Database in a line graph in chronological order</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;Errors&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TimeGenerated</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span>  
</span></span></code></pre></div></p><p>Description :<br>Understanding the number of errors that occur in the database will help resolve the actual failures and prevent potential failures.</p></details></div><div><details><summary>Azure SQL Managed Instance: View resource usage for Azure SQL Managed Instance</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ResourceUsageStats&#34;</span>
</span></span></code></pre></div></p><p>Description :<br>You can check the usage status of various resources of Azure SQL Managed Instance by specifying &ldquo;ResourceUsageStats&rdquo; as the Category operator.</p></details></div><div><details><summary>Azure SQL Managed Instance: View average CPU usage, read bytes, and write bytes for Azure SQL Managed Instance</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ResourceUsageStats&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>avg_cpu_percent_s</span>, <span style=color:#a6e22e>io_bytes_read_s</span>, <span style=color:#a6e22e>io_bytes_written_s</span>
</span></span></code></pre></div></p><p>Description :<br>You can see the CPU usage per second in the avg_cpu_percent_s column, the number of bytes read per second in the io_bytes_read_s column, and the number of bytes written per second in the io_bytes_written column.</p></details></div><div><details><summary>Azure SQL Managed Instance: Display the average CPU usage, read bytes, and write bytes average for Azure SQL Managed Instance every 5 minutes, sorted in time, in ascending order.</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ResourceUsageStats&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>sort</span> <span style=color:#a6e22e>by</span>  <span style=color:#a6e22e>asc</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>todouble</span>(<span style=color:#a6e22e>avg_cpu_percent_s</span>)), <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>todouble</span>(<span style=color:#a6e22e>io_bytes_read_s</span>)), <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>todouble</span>(<span style=color:#a6e22e>io_bytes_written_s</span>)) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span></code></pre></div></p><p>Description :<br>The avg_cpu_percent_s, io_bytes_read_s, and io_bytes_written columns are string types and must be converted to numeric types to get the average. It also sorts by TimeGenerated to display in chronological order.</p></details></div><div><details><summary>Azure SQL Managed Instance: View the average 5-minute average CPU usage, read bytes, and write bytes for Azure SQL Managed Instance in a line chart, sorted in ascending order by time.</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ResourceUsageStats&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>sort</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>asc</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>todouble</span>(<span style=color:#a6e22e>avg_cpu_percent_s</span>)), <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>todouble</span>(<span style=color:#a6e22e>io_bytes_read_s</span>)), <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>todouble</span>(<span style=color:#a6e22e>io_bytes_written_s</span>)) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span>
</span></span></code></pre></div></p><p>Description :<br>Use the render operator with the timechart keyword to display a line chart.</p></details></div><div><details><summary>Azure Synapse Analytics Dedicated SQL Pool: View the top 20 longest-running queries within the last 30 days (Query analysis step 1)</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;ExecRequests&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>StatementType_s</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>in</span> (<span style=color:#e6db74>&#39;Batch&#39;</span>,<span style=color:#e6db74>&#39;Execute&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Session_ID</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>SessionId_s</span>),<span style=color:#a6e22e>Request_ID</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>RequestId_s</span>),<span style=color:#a6e22e>Submit_Time</span><span style=color:#f92672>=</span><span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>SubmitTime_t</span>),<span style=color:#a6e22e>Start_Time</span><span style=color:#f92672>=</span><span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>StartTime_t</span>),<span style=color:#a6e22e>End_Time</span><span style=color:#f92672>=</span><span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>EndTime_t</span>),<span style=color:#a6e22e>Command</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>Command_s</span>),<span style=color:#a6e22e>Status</span><span style=color:#f92672>=</span><span style=color:#a6e22e>min</span>(<span style=color:#a6e22e>Status_s</span>), <span style=color:#a6e22e>Statement_Type</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>StatementType_s</span>),<span style=color:#a6e22e>Resource_class</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>ResourceClass_s</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>RequestId_s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>ElapsedTime_min</span><span style=color:#f92672>=</span><span style=color:#a6e22e>anyif</span>((<span style=color:#a6e22e>End_Time</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>Start_Time</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span><span style=color:#a6e22e>m</span>,<span style=color:#a6e22e>Start_Time</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>30</span><span style=color:#a6e22e>d</span>)),<span style=color:#a6e22e>Session_ID</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>Session_ID</span>), <span style=color:#a6e22e>Submit_Time</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>Submit_Time</span>) ,<span style=color:#a6e22e>Start_Time</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>Start_Time</span>), <span style=color:#a6e22e>End_Time</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>End_Time</span>),<span style=color:#a6e22e>Command</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>Command</span>),<span style=color:#a6e22e>Status</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>Status</span>),<span style=color:#a6e22e>Statement_Type</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>Statement_Type</span>),<span style=color:#a6e22e>Resource_class</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>Resource_class</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Request_ID</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>ElapsedTime_min</span> <span style=color:#a6e22e>desc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>limit</span> <span style=color:#ae81ff>20</span>
</span></span></code></pre></div></p><p>Description :<br>In the ExecRequests category of the Dedicated SQL Pool, you can see the execution time of the query. Depending on the execution time / state of the query, the information for one query may be displayed over multiple lines, so use the summarize operator to display only the information you need. The processing time is calculated from the difference between the query end time (End_Time) and the start time (Start_Time). If you need to check for a longer period, increase the value of the previous operator argument (30d (30 days) in the sample). Also, if you want to increase the number of items displayed, increase the value of the limit operator. The value in the Request_ID column will be used in step 2.</p></details></div><div><details><summary>Azure Synapse Analytics Dedicated SQL Pool: Show the number of data processed in each step of the distributed query (Query analysis step 2)</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span>  <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;RequestSteps&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>RequestId_s</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;QIDnnnnnn&#39;</span> <span style=color:#75715e>//Put your QueryID here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Status_s</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;Running&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>StartTime_t</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>EndTime_t</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>RequestId_s</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>OperationType_s</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>RowCount_d</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>Command_s</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>Status_s</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>StepIndex_d</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>StepIndex_d</span> <span style=color:#a6e22e>asc</span>
</span></span></code></pre></div></p><p>Description :<br>In the RequestSteps category of the Dedicated SQL Pool, you can get information about each step in a distributed query. You can consider what to do by looking at the steps that are taking the longest time. Specify the Request_ID value (obtained in query analysis step 1) of the query you want to analyze in the query.</p></details></div><div><details><summary>Azure Synapse Analytics Dedicated SQL Pool: View the top 20 most processed query steps in the last 30 days (Query analysis step 3)</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span>  <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;RequestSteps&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>elapsedTime</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>EndTime_t</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>StartTime_t</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>elapsedTime_min</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>elapsedTime</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1</span><span style=color:#a6e22e>m</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>EndTime_t</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>30</span><span style=color:#a6e22e>d</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>StartTime_t</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>30</span><span style=color:#a6e22e>d</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>RowCount_d</span> <span style=color:#a6e22e>desc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>RequestId_s</span>,<span style=color:#a6e22e>OperationType_s</span>, <span style=color:#a6e22e>RowCount_d</span>,<span style=color:#a6e22e>elapsedTime_min</span> , <span style=color:#a6e22e>StartTime_t</span>, <span style=color:#a6e22e>EndTime_t</span>, <span style=color:#a6e22e>Status_s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>limit</span> <span style=color:#ae81ff>20</span>
</span></span></code></pre></div></p><p>Description :<br>In the RequestSteps category of the Dedicated SQL Pool, you can get information about each step in a distributed query. By checking the query step that takes the longest time, you can find the query that needs to be dealt with. If you need to check for a longer period, increase the value of the previous operator argument (30d (30 days) in the sample). Also, if you want to increase the number of items displayed, increase the value of the limit operator. The value in the Request_ID column will be used in step 4.</p></details></div><div><details><summary>Azure Synapse Analytics Dedicated SQL Pool: Display the processing time of the entire query of the distributed query step with a large number of processing (Query analysis step 4)</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span>  <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;RequestSteps&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>RequestId_s</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;QIDnnnnn&#39;</span> <span style=color:#75715e>//Insert your QID here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Status_s</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;Running&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>StartTime_t</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>EndTime_t</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>RequestId_s</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>OperationType_s</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>RowCount_d</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>Command_s</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>Status_s</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>StepIndex_d</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>StepIndex_d</span> <span style=color:#a6e22e>asc</span>
</span></span></code></pre></div></p><p>Description :<br>You can check the query processing status in the ExecRequests category of the Dedicated SQL Pool. Specify the Request_ID value (obtained in query analysis step 2) of the query you want to analyze in the query.</p></details></div><h3 id=avd>AVD</h3><div><details><summary>List all tables related to AVD</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>search</span> <span style=color:#f92672>*</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>$table</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>$table</span> <span style=color:#a6e22e>startswith</span> <span style=color:#e6db74>&#34;WVD&#34;</span>
</span></span></code></pre></div></p><p>Description :<br>Diagnostic logs related to AVD are sent out to separate tables for each type. This query lists the all tables related to AVDs (logs must have sent within the last 24 hours).
For more information for diagnostic logs for AVD<br><a href=https://docs.microsoft.com/ja-jp/azure/virtual-desktop/diagnostics-log-analytics>https://docs.microsoft.com/ja-jp/azure/virtual-desktop/diagnostics-log-analytics</a></p></details></div><div><details><summary>Display changes in number of active sessions in 5 minute intervals in the last 24 hours</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDAgentHealthStatus</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>TotalActiveSessions</span><span style=color:#f92672>=</span><span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>toint</span>(<span style=color:#a6e22e>ActiveSessions</span>))<span style=color:#f92672>/</span><span style=color:#ae81ff>10</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span> 
</span></span></code></pre></div></p><p>Description :<br>AVD Agent send various status information including the number of active sessions every 30 seconds to &lsquo;WVDAgentHealthStatus&rsquo; table.
This query display changes in number of inactive sessions (e.g. press &lsquo;x&rsquo; button to close the window but the session remains) aggregated by sum() function.</p></details></div><div><details><summary>Display changes in number of inactive sessions in 5 minute intervals in the last 24 hours</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDAgentHealthStatus</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>TotalInactiveSessions</span><span style=color:#f92672>=</span><span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>toint</span>(<span style=color:#a6e22e>InactiveSessions</span>))<span style=color:#f92672>/</span><span style=color:#ae81ff>10</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span> 
</span></span></code></pre></div></p><p>Description :<br>Display changes in number of inactive sessions (e.g. press &lsquo;x&rsquo; button to close the window but the session remains) aggregated by sum() function</p></details></div><div><details><summary>List the number of active/inactive sessions per session-hosts</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDAgentHealthStatus</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>10</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>arg_max</span>(<span style=color:#a6e22e>TimeGenerated</span>,<span style=color:#f92672>*</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>SessionHostName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>SessionHostName</span>, <span style=color:#a6e22e>ActiveSessions</span>, <span style=color:#a6e22e>InactiveSessions</span>, <span style=color:#a6e22e>TimeGenerated</span>
</span></span></code></pre></div></p><p>Description :<br>List the number of active/inactive sessions from currently (at least last 10 mins) available session-hosts</p></details></div><div><details><summary>List errors may caused by AVD control-plane in the last 24 hours</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDErrors</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>) 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ServiceError</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;true&#34;</span> 
</span></span></code></pre></div></p><p>Description :<br>List errors for &lsquo;ServiceError&rsquo; column is set to &rsquo;true&rsquo;, these records indicate you need to escalate the issue to Microsoft support</p></details></div><div><details><summary>Count the number of errors group by each error type</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDErrors</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>) 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ServiceError</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;false&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>NumOfErrors</span><span style=color:#f92672>=</span><span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>ActivityType</span>, <span style=color:#a6e22e>Source</span>, <span style=color:#a6e22e>CodeSymbolic</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>sort</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Source</span>
</span></span></code></pre></div></p><p>Description :<br></p></details></div><div><details><summary>Count the number of errors group by each user in the last 24 hours</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDErrors</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>) 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ServiceError</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;false&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>NumOfErrors</span><span style=color:#f92672>=</span><span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>UserName</span>
</span></span></code></pre></div></p><p>Description :<br></p></details></div><div><details><summary>List of errors for specified user as &lt;<em>User UPN</em>> in the last 24 hours</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDErrors</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>) 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ServiceError</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;false&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>UserName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&lt;User UPN&gt;&#34;</span>
</span></span></code></pre></div></p><p>Description :<br></p></details></div><div><details><summary>List source IP addresses connecting to session-host per HostPool over the last 24 hours</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDConnections</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>Multi</span><span style=color:#f92672>=</span><span style=color:#a6e22e>split</span>(<span style=color:#a6e22e>_ResourceId</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>HostPool</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>Multi</span>[<span style=color:#ae81ff>8</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>ClientSideIPAddress</span>, <span style=color:#a6e22e>HostPool</span>
</span></span></code></pre></div></p><p>Description :<br></p></details></div><div><details><summary>List per-user connection duration for specified HostPool as &lt;<em>Host Pool</em>> over the last 24 hours</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDConnections</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>)  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>Multi</span><span style=color:#f92672>=</span><span style=color:#a6e22e>split</span>(<span style=color:#a6e22e>_ResourceId</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>HostPool</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>Multi</span>[<span style=color:#ae81ff>8</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>HostPool</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&lt;Host Pool&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>State</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Connected&#34;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>CorrelationId</span>, <span style=color:#a6e22e>UserName</span>, <span style=color:#a6e22e>StartTime</span><span style=color:#f92672>=</span><span style=color:#a6e22e>TimeGenerated</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span><span style=color:#a6e22e>inner</span>(<span style=color:#a6e22e>WVDConnections</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>State</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Completed&#34;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>EndTime</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#a6e22e>CorrelationId</span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>CorrelationId</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>Duration</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>EndTime</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>StartTime</span>, <span style=color:#a6e22e>UserName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>ConnectionTimeTotal</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>Duration</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>UserName</span>
</span></span></code></pre></div></p><p>Description :<br>The &lsquo;WVDConnections&rsquo; table contains connect/disconnect event by users.
This query aggregates the time between connect and disconnect event from a session host and calculates the cumulative connection time for each user.
Since the &lsquo;CorrelationId&rsquo; of the connect and disconnect events for the same session match, &lsquo;join&rsquo; is used to combine the connect and disconnect event into a single record.</p></details></div><div><details><summary>Display connection duration per user for specified HostPool as &lt;<em>Host Pool</em>> over the past week</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDConnections</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>7</span><span style=color:#a6e22e>d</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>Multi</span><span style=color:#f92672>=</span><span style=color:#a6e22e>split</span>(<span style=color:#a6e22e>_ResourceId</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>HostPool</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>Multi</span>[<span style=color:#ae81ff>8</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>HostPool</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&lt;Host Pool&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>State</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Connected&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>CorrelationId</span>, <span style=color:#a6e22e>UserName</span>, <span style=color:#a6e22e>StartTime</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>TimeGenerated</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span><span style=color:#a6e22e>inner</span>(<span style=color:#a6e22e>WVDConnections</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>State</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Completed&#34;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>EndTime</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#a6e22e>CorrelationId</span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>CorrelationId</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>DurationInMinutes</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>EndTime</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>StartTime</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span><span style=color:#a6e22e>m</span>, <span style=color:#a6e22e>UserName</span>, <span style=color:#a6e22e>EndTime</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>ConnectionTimeInMinutes</span><span style=color:#f92672>=</span><span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>DurationInMinutes</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>EndTime</span>, <span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>), <span style=color:#a6e22e>UserName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span>
</span></span></code></pre></div></p><p>Description :<br>This query extend the above query to provide graphical view to see transition of connection duration for each user.<br>In Line:11, subtracting &lsquo;datetime&rsquo; types result in &rsquo;timespan&rsquo; type, but since this type cannot be rendered as is, convert to a scalar value in minutes by divide by &lsquo;1m&rsquo;.</p></details></div><div><details><summary>Display connection latency per HostPool between session host and client device over the last 24 hours</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDConnectionNetworkData</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>Multi</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>split</span>(<span style=color:#a6e22e>_ResourceId</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>HostPool</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>Multi</span>[<span style=color:#ae81ff>8</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>EstRoundTripTimeInMs</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>10</span><span style=color:#a6e22e>m</span>), <span style=color:#a6e22e>HostPool</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span> 
</span></span></code></pre></div></p><p>Description :<br>The &lsquo;WVDConnectionNetworkData&rsquo; table contains estimated latency of session host.
This query display the latency per HostPool over the last 24 hours an every 10 minutes average.</p></details></div><div><details><summary>Display connection latency per HostPool between session host and client device for specified user as &lt;<em>User UPN</em>> over the last 24 hours</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDConnectionNetworkData</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span><span style=color:#a6e22e>inner</span> (<span style=color:#a6e22e>WVDConnections</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>CorrelationId</span>, <span style=color:#a6e22e>UserName</span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>CorrelationId</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>UserName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&lt;User UPN&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>EstRoundTripTimeInMs</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>10</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span> 
</span></span></code></pre></div></p><p>Description :<br>This query display the connection latency for specified user over the last 24 hours as an every 10 minutes average.</p></details></div><h3 id=application-insights>Application Insights</h3><div><details><summary>Count request within past 12 hours</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>requests</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>timestamp</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>12</span><span style=color:#a6e22e>h</span>) 
</span></span></code></pre></div></p><p>Description :<br>The &lsquo;requests&rsquo; table is a table of HTTP requests collected in Application Insights.</p></details></div><div><details><summary>Count failed request within past 12 hours</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>requests</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>timestamp</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>12</span><span style=color:#a6e22e>h</span>) 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>success</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>false</span>
</span></span></code></pre></div></p><p>Description :<br>In the &lsquo;requests&rsquo; table, there is a row of type &lsquo;boolean&rsquo; called &lsquo;success&rsquo;. You can aggregate failed requests by setting &lsquo;sucess&rsquo; to &lsquo;false&rsquo;.</p></details></div><div><details><summary>Count performance with requests and summaize avarage, 50, 95, 99 percentile</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>requests</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>RequestsCount</span><span style=color:#f92672>=</span><span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>itemCount</span>), <span style=color:#a6e22e>AverageDuration</span><span style=color:#f92672>=</span><span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>duration</span>), <span style=color:#a6e22e>percentiles</span>(<span style=color:#a6e22e>duration</span>, <span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>95</span>, <span style=color:#ae81ff>99</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>operation_Name</span>
</span></span></code></pre></div></p><p>Description :<br>In the &lsquo;requests&rsquo; table, there is data that represents the time it took to respond &lsquo;duration&rsquo;. You can use &lsquo;avg&rsquo; to aggregate averages and &lsquo;percentiles&rsquo; to aggregate in percentiles.</p></details></div><div><details><summary></summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>requests</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>CountByCountry</span><span style=color:#f92672>=</span><span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>client_CountryOrRegion</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>CountByCountry</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>piechart</span>
</span></span></code></pre></div></p><p>Description :<br>NA</p></details></div><div><details><summary>Show page view data</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>pageViews</span>
</span></span></code></pre></div></p><p>Description :<br>To aggregate pageviews, use the table in &lsquo;pageViews&rsquo;.</p></details></div><div><details><summary>Show page view from browser data</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>pageViews</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>client_type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;Browser&#39;</span>
</span></span></code></pre></div></p><p>Description :<br>NA</p></details></div><div><details><summary></summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>pageViews</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>notempty</span>(<span style=color:#a6e22e>duration</span>) <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>client_Type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;Browser&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>total_duration</span><span style=color:#f92672>=</span><span style=color:#a6e22e>duration</span><span style=color:#f92672>*</span><span style=color:#a6e22e>itemCount</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>avg_duration</span><span style=color:#f92672>=</span>(<span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>total_duration</span>)<span style=color:#f92672>/</span><span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>itemCount</span>)) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>operation_Name</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>avg_duration</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>Description :<br>NA</p></details></div><h3 id=security>Security</h3><div><details><summary>Detect continuous logon failures for the same user</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>threshold</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>unit</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span><span style=color:#a6e22e>m</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>SigninLogs</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ResultType</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>in</span> (<span style=color:#e6db74>&#34;0&#34;</span>, <span style=color:#e6db74>&#34;50125&#34;</span>, <span style=color:#e6db74>&#34;50140&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>loginfailure</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>UserPrincipalName</span>, <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>,<span style=color:#a6e22e>unit</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>loginfailure</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>threshold</span> 
</span></span></code></pre></div></p><p>Description :<br><p>This query is a sample for detecting brute force attacks.
Detects sign-in failures from the SigninLogs table that exceed the number of times set in <code>threshold</code> within the time set in <code>unit</code>.
ResultType contains the result of the sign-in, where 0 means the sign-in was successful and there are no problems; 50125 and 50140 are events that are logged when the password is reset and when the sign-in memory is set, respectively, and are not failures, which can occur frequently. The following is an example.</p><p>SigninLogs records the sign-in of users and others to Azure AD. This logging can be enabled through Azure AD diagnostic settings and requires an Azure AD Premium P1 or P2 license.
These codes are subject to change in the future, but for more information on [Azure AD Authentication and Authorization Error Codes](<a href=https://docs.microsoft.com/azure/active-directory/develop/reference-aadsts->https://docs.microsoft.com/azure/active-directory/develop/reference-aadsts-</a> error-codes), and you can also check the messages corresponding to the codes at <a href=https://login.microsoftonline.com/error>https://login.microsoftonline.com/error</a>.</p></p></details></div><div><details><summary>Detect continuous logon failures for different users</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>threshold</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>unit</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span><span style=color:#a6e22e>m</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>SigninLogs</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ResultType</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>in</span> (<span style=color:#e6db74>&#34;0&#34;</span>, <span style=color:#e6db74>&#34;50125&#34;</span>, <span style=color:#e6db74>&#34;50140&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>loginfailure</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dcount</span>(<span style=color:#a6e22e>UserPrincipalName</span>) <span style=color:#a6e22e>by</span>  <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>,<span style=color:#a6e22e>unit</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>loginfailure</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>threshold</span> 
</span></span></code></pre></div></p><p>Description :<br>This query is a sample for detecting password spray attacks.
Brute force is an attack that attempts multiple passwords for a specific user, but since it is easy to evade and detect by locking accounts, password sprayers fix passwords to the most commonly used ones and attempt sign-in while changing users.
This query counts sign-in failures by unique users recorded within the time specified by <code>unit</code> and detects those that exceed the threshold.</p></details></div><div><details><summary>Display IP addresses of clients whose number of errors logged by Application Gateway in the past is higher than the threshold value</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>threshold</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>lookback</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span><span style=color:#a6e22e>m</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#a6e22e>lookback</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ApplicationGatewayAccessLog&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>httpStatus_d</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>300</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>ErrCount</span><span style=color:#f92672>=</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>clientIP_s</span>,<span style=color:#a6e22e>userAgent_s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ErrCount</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>threshold</span>
</span></span></code></pre></div></p><p>Description :<br>Application Gateway accesses are logged in the ApplicationGatewayAccessLog category in AzureDiagnostics.
During the reconnaissance phase, since errors are often logged with HTTP status codes, records with a status code of error (300) or higher are filtered. We find accesses that appear to be reconnaissance by detecting IP addresses that have recorded errors above a pre-defined threshold.
This query may mis-detect cases where back-end services have failed, or where multiple users from a location access the Internet through a single gateway, but they are considered to originate from the same IP address. This may cause the system to not work properly. As a mitigation measure, in addition to IP addresses, UserAgent_s is used to distinguish access sources by user agent strings, but this is not sufficient.</p></details></div><div><details><summary>Display client IP addresses that are causing access errors for multiple applications in Application Gateway</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>threshold</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>lookback</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span><span style=color:#a6e22e>m</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#a6e22e>lookback</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ApplicationGatewayAccessLog&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>httpStatus_d</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>300</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>UriCount</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dcount</span>(<span style=color:#a6e22e>requestUri_s</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>clientIP_s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>UriCount</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>threshold</span>
</span></span></code></pre></div></p><p>Description :<br>During the reconnaissance phase, accesses may be made to multiple application paths in order to brute force the paths and identify vulnerable applications. This results in multiple requestUri_s errors within a unit of time.
dcount is a function that counts the number of unique counts for a given column. In this query, the number of unique requestUri_s for clientIP_s, i.e., the number of applications that have attempted access from a particular clientIP_s, is tallied.
The record httpStatus_d is filtered for errors, so the number of applications that fail to access from a given IP can be compared to a threshold to detect attacks.
Note that in actual attacks, the source IPs may be distributed across multiple locations.</p></details></div><div><details><summary>Application Gateway displays IP addresses of clients who successfully accessed the application after multiple access errors</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>lookback</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span><span style=color:#a6e22e>m</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>threshold</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>SuccessIPs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#a6e22e>lookback</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ApplicationGatewayAccessLog&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>httpStatus_d</span> <span style=color:#a6e22e>between</span> (<span style=color:#ae81ff>200</span> .. <span style=color:#ae81ff>299</span>) 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>AccessTime</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>TimeGenerated</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>clientIP_s</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#a6e22e>lookback</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>httpStatus_d</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>300</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span><span style=color:#a6e22e>inner</span> <span style=color:#a6e22e>SuccessIPs</span> <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>clientIP_s</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>AccessTime</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>ErrBeforeSuccess</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>clientIP_s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ErrBeforeSuccess</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>threshold</span>
</span></span></code></pre></div></p><p>Description :<br>Although errors often occur during the reconnaissance phase, if the HTTP access success code changes after a series of errors, the application may have succeeded in gaining unauthorized access.
This query creates a dataset of the last successful access time for each IP address from the ApplicationGatewayAccessLog and joins it with a dataset of only the errors from the original ApplicationGatewayAccessLog.
Since the time of the successful access is included in the AccessTime column, TimeGenerated counts records that are smaller (older) than this and detects that the error occurred more than a threshold number of times before the successful access.</p></details></div><div><details><summary>Display attacks detected by the Web Application Firewall</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span><span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ApplicationGatewayFirewallLog&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>TimeGenerated</span>,<span style=color:#a6e22e>clientIp_s</span>,<span style=color:#a6e22e>hostname_s</span>,<span style=color:#a6e22e>requestUri_s</span>,<span style=color:#a6e22e>ruleSetVersion_s</span>,<span style=color:#a6e22e>ruleId_s</span>,<span style=color:#a6e22e>Message</span>,<span style=color:#a6e22e>details_message_s</span>,<span style=color:#a6e22e>details_data_s</span>
</span></span></code></pre></div></p><p>Description :<br>If WAF is enabled, the ApplicationGatewayFirewallLog category can record the detection results of WAF rules. This query shows the most frequently used items for WAF rule detection.</p></details></div><div><details><summary>zureActivity detects new Administrative operations that had not occurred in the past month</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>past1month</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>AzureActivity</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>30</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>startofday</span>(<span style=color:#a6e22e>now</span>()))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>CategoryValue</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Administrative&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span>  <span style=color:#a6e22e>OperationNameValue</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>AzureActivity</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span>  <span style=color:#a6e22e>startofday</span>(<span style=color:#a6e22e>now</span>())
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>CategoryValue</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Administrative&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>OperationNameValue</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>in</span> (<span style=color:#a6e22e>past1month</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#a6e22e>OperationNameValue</span>, <span style=color:#a6e22e>OperationName</span>, <span style=color:#a6e22e>ResourceGroup</span>, <span style=color:#a6e22e>ResourceProviderValue</span>, <span style=color:#a6e22e>Caller</span>
</span></span></code></pre></div></p><p>Description :<br>The Administrative table records administrative operations in <code>Administrative</code>. When no system changes have occurred, administrative operations are recorded consistently, but if new, unrecorded operations are suddenly recorded, this may indicate that new change work has occurred or that a security breach has occurred.</p></details></div><div><details><summary>View computers with processes that are not running on other computers</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMProcess</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>UniqueProcesses</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dcount</span>(<span style=color:#a6e22e>Computer</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>ExecutableName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>UniqueProcesses</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> (
</span></span><span style=display:flex><span><span style=color:#a6e22e>VMProcess</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>ExecutableName</span>, <span style=color:#a6e22e>ExecutablePath</span>
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>ExecutableName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>ExecutableName</span>, <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>ExecutablePath</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>ExecutableName</span>
</span></span></code></pre></div></p><p>Description :<br>Since server workloads will have the same process running on computers in the same role, if a unique process is running, it may be performing some special operation.
This could be due to some change work, or it could indicate a security breach.</p></details></div><div><details><summary>Check the weekly change in Secure Score</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>SecureScores</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>7</span><span style=color:#a6e22e>d</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>SecureScorePercentage</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>PercentageScore</span><span style=color:#f92672>*</span><span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>AverageScore</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>SecureScorePercentage</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>)
</span></span></code></pre></div></p><p>Description :<br>Security Score is a Posture Management feature of Microsoft Defender for Cloud that is available free of charge.
Use Azure Policy to check that Microsoft&rsquo;s recommended settings are in place.
Maintain it at 90% or better, as it changes daily with the addition of workloads and the release of updates.</p></details></div><div><details><summary>Detect data transmissions from resources in the ApplicationGateway back-end pool</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>backend</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ApplicationGatewayAccessLog&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>serverRouted_s</span> <span style=color:#f92672>&lt;&gt;</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>serverRouted_s</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;AzureFirewallNetworkRule&#34;</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;AzureFirewallApplicationRule&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#66d9ef>with</span> <span style=color:#f92672>*</span>  <span style=color:#e6db74>&#34; request from &#34;</span> <span style=color:#a6e22e>SourceIP</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#a6e22e>SourcePort</span> <span style=color:#e6db74>&#34; to &#34;</span> <span style=color:#a6e22e>Dest</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#a6e22e>DestPort</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>TimeGenerated</span>,<span style=color:#a6e22e>SourceIP</span>,<span style=color:#a6e22e>SourcePort</span>,<span style=color:#a6e22e>Dest</span>,<span style=color:#a6e22e>DestPort</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>SourceIP</span> <span style=color:#66d9ef>in</span> (<span style=color:#a6e22e>backend</span>)
</span></span></code></pre></div></p><p>Description :<br>Communications to the back end of the Application Gateway are filtered by the Web Applicaiton Firewall, but the back end may receive undetected attack payloads.
Payloads may behave in a variety of ways, but some generate outbound data communications to communicate with C&C servers on the Internet.
This query assumes an environment where the Azure Firewall is in use and all Internet-facing communications are configured to be routed to the Azure Firewall.
Create a list of serverRouted_s since the IP addresses of the back-end servers of the pplicationGateway are recorded in serverRouted_s.
Since Azure Firewall records the source address for both IP-based network rules and URL-based application rules, the backend that attempted to send data is the one whose source address matches the list of backends created in advance.</p></details></div><div><details><summary>View who has interactively logged in to the computer</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>SecurityEvent</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>EventID</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>4624</span> <span style=color:#a6e22e>and</span> (<span style=color:#a6e22e>LogonType</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>LogonType</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>10</span>) <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>AccountType</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;User&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>Account</span>
</span></span></code></pre></div></p><p>Description :<br>Generally, servers in operation do not have interactive logons except for periods of change management.
SecurityEvent is logged by Windows security logs, but can implement simple security monitoring by detecting interactive login events.
A paid SKU of Defender for Cloud is required to obtain SecurityEvents.</p></details></div><div><details><summary>Detect outbound access to IP addresses included in threat intelligence</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>maliciousIPs</span> <span style=color:#f92672>=</span> 
</span></span><span style=display:flex><span><span style=color:#a6e22e>ThreatIntelligenceIndicator</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>NetworkIP</span> <span style=color:#f92672>&lt;&gt;</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>Active</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>true</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>ExpirationDateTime</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>now</span>()
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>NetworkIP</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;AzureFirewallNetworkRule&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#66d9ef>with</span> <span style=color:#f92672>*</span>  <span style=color:#e6db74>&#34; request from &#34;</span> <span style=color:#a6e22e>SourceIP</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#a6e22e>SourcePort</span> <span style=color:#e6db74>&#34; to &#34;</span> <span style=color:#a6e22e>DestIP</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#a6e22e>DestPort</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>DestIP</span>  <span style=color:#66d9ef>in</span> (<span style=color:#a6e22e>maliciousIPs</span>)
</span></span></code></pre></div></p><p>Description :<br>Azure Sentinel is required to perform this query; Azure Sentinel has data connectors to federate logs from various data sources and can pull in threat intelligence (untrusted IPs, URLs, file hashes, etc.).
In this example, the Azure Firewall logs are queried against active untrusted IP addresses obtained from threat intelligence to see if there is any suspicious external access.</p></details></div><h3 id=resource-graph>Resource Graph</h3><div><details><summary>View subscriptions with no Key Vaults</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>ResourceContainers</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>==</span><span style=color:#e6db74>&#39;microsoft.resources/subscriptions&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>id</span> <span style=color:#66d9ef>with</span> <span style=color:#e6db74>&#34;/subscriptions/&#34;</span> <span style=color:#a6e22e>SubscriptionID</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>subscriptionId</span>, <span style=color:#a6e22e>SubscriptionName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span><span style=color:#a6e22e>leftouter</span> (
</span></span><span style=display:flex><span><span style=color:#a6e22e>Resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;microsoft.keyvault/vaults&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>subscriptionId</span>
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>subscriptionId</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span> <span style=color:#a6e22e>leftouter</span> (
</span></span><span style=display:flex><span><span style=color:#a6e22e>Resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;microsoft.keyvault/vaults&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>ResourceCount</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>subscriptionId</span>
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>subscriptionId</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>RCount</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>iff</span>(<span style=color:#a6e22e>isnull</span>(<span style=color:#a6e22e>ResourceCount</span>), <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>ResourceCount</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span><span style=color:#f92672>-</span><span style=color:#a6e22e>away</span> <span style=color:#a6e22e>ResourceCount</span>, <span style=color:#a6e22e>subscriptionId1</span>, <span style=color:#a6e22e>subscriptionId2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>HealthStatus</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>iff</span>(<span style=color:#a6e22e>RCount</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#34;Not Compliant&#34;</span>, <span style=color:#e6db74>&#34;Compliant&#34;</span>)
</span></span></code></pre></div></p><p>Description :<br>You can use this query in Azure Resource Graph to identify any subscriptions that do not contain KeyVaults.</p></details></div><div><details><summary>View status of Azure Monitor Agents for all virtual machines</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.compute/virtualmachines&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>ComputerName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>subscriptionId</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span><span style=color:#a6e22e>leftouter</span>  (
</span></span><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.compute/virtualmachines/extensions&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>name</span> <span style=color:#66d9ef>in</span> (<span style=color:#e6db74>&#34;AzureMonitorLinuxAgent&#34;</span>, <span style=color:#e6db74>&#34;AzureMonitorWindowsAgent&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>id</span> <span style=color:#66d9ef>with</span> <span style=color:#f92672>*</span> <span style=color:#e6db74>&#34;/virtualMachines/&#34;</span> <span style=color:#a6e22e>ComputerName</span> <span style=color:#e6db74>&#34;/extensions/&#34;</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>AMAStatus</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>provisioningState</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WorkspaceID</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>workspaceId</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>AMA</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>ComputerName</span>, <span style=color:#a6e22e>AMAStatus</span>
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>ComputerName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span><span style=color:#a6e22e>leftouter</span>  (
</span></span><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.compute/virtualmachines/extensions&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>name</span> <span style=color:#66d9ef>in</span> (<span style=color:#e6db74>&#34;MicrosoftMonitoringAgent&#34;</span>, <span style=color:#e6db74>&#34;OmsAgentForLinux&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>id</span> <span style=color:#66d9ef>with</span> <span style=color:#f92672>*</span> <span style=color:#e6db74>&#34;/virtualMachines/&#34;</span> <span style=color:#a6e22e>ComputerName</span> <span style=color:#e6db74>&#34;/extensions/&#34;</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>MMAStatus</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>provisioningState</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WorkspaceID</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>workspaceId</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>MMA</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>ComputerName</span>, <span style=color:#a6e22e>MMAStatus</span>, <span style=color:#a6e22e>WorkspaceID</span>
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>ComputerName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span><span style=color:#a6e22e>leftouter</span>  (
</span></span><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.operationalinsights/workspaces&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>WorkspaceID</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>customerId</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>WorkspaceName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>WorkspaceID</span>
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>WorkspaceID</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span><span style=color:#f92672>-</span><span style=color:#a6e22e>away</span> <span style=color:#a6e22e>WorkspaceID1</span>, <span style=color:#a6e22e>ComputerName1</span>, <span style=color:#a6e22e>ComputerName2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> [<span style=color:#e6db74>&#34;Both Agents&#34;</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>iff</span>(<span style=color:#a6e22e>isnotempty</span>(<span style=color:#a6e22e>AMA</span>) <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>isnotempty</span>(<span style=color:#a6e22e>MMA</span>), <span style=color:#e6db74>&#34;True&#34;</span>, <span style=color:#e6db74>&#34;False&#34;</span>)
</span></span></code></pre></div></p><p>Description :<br>You can use this query in Azure Resource Graph to identify which virtual machines have both the Azure Monitor Agent and the Microsoft Monitoring Agent deployed, and which workspace the MMA reports to.</p></details></div><div><details><summary>View Orphan Managed disks</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>=~</span> <span style=color:#e6db74>&#39;microsoft.compute/Disks&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>managedBy</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>id</span>
</span></span></code></pre></div></p><p>Description :<br>You can use this query in Azure Resource Graph to identify any orphaned disks.</p></details></div><div><details><summary>View Orphaned NICs</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.network/networkinterfaces&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>isnull</span> (<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>virtualMachine</span>) <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>isnull</span> (<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>privateEndpoint</span>)
</span></span></code></pre></div></p><p>Description :<br>This query can be used in Azure Resource Graph to identify any detached NIC</p></details></div><div><details><summary>View Orphaned NSGs</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>=~</span> <span style=color:#e6db74>&#39;microsoft.network/networksecuritygroups&#39;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>isnull</span>(<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>networkInterfaces</span>) <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>isnull</span>(<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>subnets</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>resourceGroup</span>
</span></span></code></pre></div></p><p>Description :<br>This query can be used in Azure Resource Graph to identify any used Network Security Group</p></details></div><div><details><summary>View Orphaned Route Tables</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.network/routetables&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>isnull</span>(<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>subnets</span>)
</span></span></code></pre></div></p><p>Description :<br>This query can be used in Azure Resource Graph to identify any unused route table</p></details></div><div><details><summary>Show Storage accounts with public endpoints</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.storage/storageaccounts&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>allowBlobPublicAccess</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;true&#39;</span>
</span></span></code></pre></div></p><p>Description :<br>This query can be used in Azure Resource Graph to identify any storage account with public endpoints</p></details></div><div><details><summary>Show Storage accounts with non-encrypted transfers enabled</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>  <span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.storage/storageaccounts&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>allowBlobPublicAccess</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;true&#39;</span>        
</span></span></code></pre></div></p><p>Description :<br>This query can be used in Azure Resource Graph to identify any storage accounts without an https requirement</p></details></div><div><details><summary>VNets: Peering Configuration</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> [<span style=color:#e6db74>&#39;type&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;microsoft.network/virtualnetworks&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>mv</span><span style=color:#f92672>-</span><span style=color:#a6e22e>expand</span> <span style=color:#a6e22e>peerings</span><span style=color:#f92672>=</span><span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>virtualNetworkPeerings</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>VNetName</span><span style=color:#f92672>=</span><span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>peeringName</span><span style=color:#f92672>=</span><span style=color:#a6e22e>peerings</span>.<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>peeringTarget</span><span style=color:#f92672>=</span><span style=color:#a6e22e>split</span>(<span style=color:#a6e22e>peerings</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>remoteVirtualNetwork</span>.<span style=color:#a6e22e>id</span>,<span style=color:#e6db74>&#34;/&#34;</span>,<span style=color:#ae81ff>8</span>)[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>peeringState</span><span style=color:#f92672>=</span><span style=color:#a6e22e>peerings</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>peeringState</span>,<span style=color:#a6e22e>useRemoteGateways</span><span style=color:#f92672>=</span><span style=color:#a6e22e>peerings</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>useRemoteGateways</span>,
</span></span><span style=display:flex><span><span style=color:#a6e22e>allowGatewayTransit</span><span style=color:#f92672>=</span><span style=color:#a6e22e>peerings</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>allowGatewayTransit</span>
</span></span></code></pre></div></p><p>Description :<br>Use this query to review the peering configuration of all Virtual Networks in scope</p></details></div><div><details><summary>Subnet details (NSG/UDR)</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> [<span style=color:#e6db74>&#39;type&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;microsoft.network/virtualnetworks&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//| project dynProperties=todynamic(properties)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#a6e22e>mv</span><span style=color:#f92672>-</span><span style=color:#a6e22e>expand</span> <span style=color:#a6e22e>subnetNames</span><span style=color:#f92672>=</span><span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>subnets</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>VNetName</span><span style=color:#f92672>=</span><span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>Subnet</span><span style=color:#f92672>=</span><span style=color:#a6e22e>subnetNames</span>.<span style=color:#a6e22e>name</span>,<span style=color:#a6e22e>AddressPrefix</span><span style=color:#f92672>=</span><span style=color:#a6e22e>subnetNames</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>addressPrefix</span>,
</span></span><span style=display:flex><span><span style=color:#a6e22e>RouteTable</span><span style=color:#f92672>=</span><span style=color:#a6e22e>split</span>(<span style=color:#a6e22e>subnetNames</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>routeTable</span>.<span style=color:#a6e22e>id</span>,<span style=color:#e6db74>&#34;/&#34;</span>,<span style=color:#ae81ff>8</span>)[<span style=color:#ae81ff>0</span>],
</span></span><span style=display:flex><span><span style=color:#a6e22e>NSG</span><span style=color:#f92672>=</span><span style=color:#a6e22e>split</span>(<span style=color:#a6e22e>subnetNames</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>networkSecurityGroup</span>.<span style=color:#a6e22e>id</span>,<span style=color:#e6db74>&#34;/&#34;</span>,<span style=color:#ae81ff>8</span>)[<span style=color:#ae81ff>0</span>],<span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;microsoft.network/subnets&#34;</span>
</span></span></code></pre></div></p><p>Description :<br>This query shows details about the subnets, Addresses, NSGs, UDRs.</p></details></div><div><details><summary>Display count of VMs by Azure location</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Resources</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.compute/virtualmachines&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Total</span><span style=color:#f92672>=</span><span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Region</span><span style=color:#f92672>=</span><span style=color:#a6e22e>location</span>
</span></span></code></pre></div></p><p>Description :<br>Use this query to display a count of VMs by Azure location</p></details></div><div><details><summary>Display a count of VMs by OS Platform</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> [<span style=color:#e6db74>&#39;type&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;microsoft.compute/virtualmachines&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>osType</span><span style=color:#f92672>=</span><span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>storageProfile</span>.<span style=color:#a6e22e>osDisk</span>.<span style=color:#a6e22e>osType</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>osType</span>)
</span></span></code></pre></div></p><p>Description :<br>Use this query to display a count of VMs by OS Platform</p></details></div><div><details><summary>List Network Interfaces associated with specific Application Security Group specified as &lt;<em>ASG</em>></summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Resources</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.network/networkinterfaces&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>isnotnull</span> (<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>ipConfigurations</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>applicationSecurityGroups</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>subscriptionId</span>, <span style=color:#a6e22e>resourceGroup</span>, <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>ASGs</span><span style=color:#f92672>=</span><span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>ipConfigurations</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>applicationSecurityGroups</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>mv</span><span style=color:#f92672>-</span><span style=color:#a6e22e>expand</span> <span style=color:#a6e22e>ASGs</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>subscriptionId</span>, <span style=color:#a6e22e>resourceGroup</span>, <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>ASG</span><span style=color:#f92672>=</span><span style=color:#a6e22e>ASGs</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ASG</span> <span style=color:#a6e22e>endswith</span> <span style=color:#e6db74>&#34;&lt;ASG&gt;&#34;</span>
</span></span></code></pre></div></p><p>Description :<br>NA</p></details></div><div class=section-index></div><div class="text-muted mt-5 pt-3 border-top">Last modified June 13, 2022: <a href=https://github.com/Azure/fta-kusto100knocks//commit/2a0a62fe3e1d45f1f066318a901412089b2e78b9>Copy from HackOn repository (2a0a62f)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/Azure/fta-kusto100knocks/ aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/fta-kusto100knocks/js/main.min.fa36cdc86af88eede756e25812c6610ddc03c55e6d93603cd21d674b095785b2.js integrity="sha256-+jbNyGr4ju3nVuJYEsZhDdwDxV5tk2A80h1nSwlXhbI=" crossorigin=anonymous></script></body></html>