<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=ja class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.100.2"><link rel=alternate type=application/rss+xml href=https://tsubasaxzzz.github.io/fta-hackon2022/ja/docs/advanced/index.xml><meta name=robots content="index, follow"><link rel="shortcut icon" href=/fta-hackon2022/favicons/favicon.ico><link rel=apple-touch-icon href=/fta-hackon2022/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/fta-hackon2022/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/fta-hackon2022/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/fta-hackon2022/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/fta-hackon2022/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/fta-hackon2022/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/fta-hackon2022/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/fta-hackon2022/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/fta-hackon2022/favicons/android-192x192.png sizes=192x192><title>応用編 | KUSTO 100+ knocks</title><meta name=description content="Azure のサービスでよく使われるクエリを学習します。"><meta property="og:title" content="応用編"><meta property="og:description" content="Azure のサービスでよく使われるクエリを学習します。"><meta property="og:type" content="website"><meta property="og:url" content="https://tsubasaxzzz.github.io/fta-hackon2022/ja/docs/advanced/"><meta itemprop=name content="応用編"><meta itemprop=description content="Azure のサービスでよく使われるクエリを学習します。"><meta name=twitter:card content="summary"><meta name=twitter:title content="応用編"><meta name=twitter:description content="Azure のサービスでよく使われるクエリを学習します。"><link rel=preload href=/fta-hackon2022/scss/main.min.e42fbc313eb1919891fde4bb3bfbacc710b8890c78adce84a179ab0f4ff8977d.css as=style><link href=/fta-hackon2022/scss/main.min.e42fbc313eb1919891fde4bb3bfbacc710b8890c78adce84a179ab0f4ff8977d.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/fta-hackon2022/ja/><span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class=font-weight-bold>KUSTO 100+ knocks</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/fta-hackon2022/ja/docs/><span class=active>ドキュメント</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>日本語</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/fta-hackon2022/docs/advanced/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>日本語</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/fta-hackon2022/docs/advanced/>English</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-fta-hackon2022jadocs-li><a href=/fta-hackon2022/ja/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-fta-hackon2022jadocs><span>ドキュメント</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-fta-hackon2022jadocsbasic-li><a href=/fta-hackon2022/ja/docs/basic/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-fta-hackon2022jadocsbasic><span>基本編</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-fta-hackon2022jadocsadvanced-li><a href=/fta-hackon2022/ja/docs/advanced/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__section" id=m-fta-hackon2022jadocsadvanced><span class=td-sidebar-nav-active-item>応用編</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-fta-hackon2022jadocsportal-li><a href=https://portal.azure.com/#blade/Microsoft_Azure_Monitoring_Logs/DemoLogsBlade target=_blank rel=noopener class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-fta-hackon2022jadocsportal><span>デモワークスペースで試す🔎</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/tsubasaxZZZ/fta-hackon2022/tree/main/content/ja/docs/Advanced/_index.md class=td-page-meta--view target=_blank rel=noopener><i class="fa fa-file-alt fa-fw"></i> View page source</a>
<a href=https://github.com/tsubasaxZZZ/fta-hackon2022/edit/main/content/ja/docs/Advanced/_index.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> ページの編集</a>
<a href="https://github.com/tsubasaxZZZ/fta-hackon2022/new/main/content/ja/docs/Advanced/_index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> 子ページを作成</a>
<a href="https://github.com/tsubasaxZZZ/fta-hackon2022/issues/new?title=%e5%bf%9c%e7%94%a8%e7%b7%a8" class=td-page-meta--issue target=_blank rel=noopener><i class="fab fa-github fa-fw"></i> ドキュメントのissueを作成</a>
<a href=https://github.com/tsubasaxZZZ/fta-hackon2022/issues/new class=td-page-meta--project-issue target=_blank rel=noopener><i class="fas fa-tasks fa-fw"></i> プロジェクトのissueを作成</a></div><div class=td-toc><nav id=TableOfContents><ul><li><ul><li><a href=#network>Network</a></li><li><a href=#compute>Compute</a></li><li><a href=#data>Data</a></li><li><a href=#avd>AVD</a></li><li><a href=#application-insights>Application Insights</a></li><li><a href=#security>Security</a></li><li><a href=#resource-graph>Resource Graph</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=https://tsubasaxzzz.github.io/fta-hackon2022/ja/docs/>ドキュメント</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://tsubasaxzzz.github.io/fta-hackon2022/ja/docs/advanced/>応用編</a></li></ol></nav><div class=td-content><h1>応用編</h1><div class=lead>Azure のサービスでよく使われるクエリを学習します。</div><header class=article-meta></header><h3 id=network>Network</h3><div><details><summary>ファイアウォールによって拒否された Azure ファイアウォール アプリケーション ルールの確認</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>q1</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>view</span>() {
</span></span><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;AzureFirewallApplicationRule&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#a6e22e>contains</span> <span style=color:#e6db74>&#34; to &#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>kind</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>regex</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>Protocol</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34; request from &#34;</span> <span style=color:#a6e22e>SourceIP</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#a6e22e>SourcePort</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34; to &#34;</span> <span style=color:#a6e22e>TargetURL</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#a6e22e>targetPort</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34;. Action: &#34;</span> <span style=color:#a6e22e>Action</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34;.\sN&#34;</span> <span style=color:#a6e22e>Reason</span>
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>q2</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>view</span>() {
</span></span><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;AzureFirewallApplicationRule&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>contains</span> <span style=color:#e6db74>&#34; to &#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>kind</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>regex</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>Protocol</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34; request from &#34;</span> <span style=color:#a6e22e>SourceIP</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#a6e22e>SourcePort</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34;. Action: &#34;</span> <span style=color:#a6e22e>Action</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34;. Reason:&#34;</span> <span style=color:#a6e22e>Reason</span>
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#a6e22e>union</span> <span style=color:#a6e22e>withsource</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;temptable&#34;</span> <span style=color:#a6e22e>q1</span>,<span style=color:#a6e22e>q2</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>SourceIP</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;xx.xx.xx.xx&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TargetURL</span>, <span style=color:#a6e22e>targetPort</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//#| summarize count() by FQDN | order by count_ desc 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>count_</span> <span style=color:#a6e22e>desc</span> 
</span></span></code></pre></div></p><p>解説 :<br>ファイアウォールによって拒否された Azure ファイアウォール アプリケーション ルールの確認</p></details></div><div><details><summary>特定の IP およびポートに対する Azure ファイアウォールの拒否接続 (ネットワーク ルール) を一覧表示する (必要に応じてクエリを変更する)</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;AzureFirewallNetworkRule&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>Protocol</span> <span style=color:#e6db74>&#34; request from &#34;</span> <span style=color:#a6e22e>SourceIP</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#a6e22e>SourcePortInt</span><span style=color:#f92672>:</span><span style=color:#66d9ef>int</span> <span style=color:#e6db74>&#34; to &#34;</span> <span style=color:#a6e22e>TargetIP</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#a6e22e>TargetPortInt</span><span style=color:#f92672>:</span><span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#66d9ef>with</span> <span style=color:#f92672>*</span> <span style=color:#e6db74>&#34;. Action: &#34;</span> <span style=color:#a6e22e>Action1a</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#66d9ef>with</span> <span style=color:#f92672>*</span> <span style=color:#e6db74>&#34;was &#34;</span> <span style=color:#a6e22e>Action1b</span> <span style=color:#e6db74>&#34; to &#34;</span> <span style=color:#a6e22e>NatDestination</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>Protocol2</span> <span style=color:#e6db74>&#34; request from &#34;</span> <span style=color:#a6e22e>SourceIP2</span> <span style=color:#e6db74>&#34; to &#34;</span> <span style=color:#a6e22e>TargetIP2</span> <span style=color:#e6db74>&#34;. Action:&#34;</span> <span style=color:#a6e22e>Action2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>SourcePort</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>SourcePortInt</span>),<span style=color:#a6e22e>TargetPort</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>TargetPortInt</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>Action</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>case</span>(<span style=color:#a6e22e>Action1a</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#66d9ef>case</span>(<span style=color:#a6e22e>Action1b</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#a6e22e>Action2</span>,<span style=color:#a6e22e>Action1b</span>), <span style=color:#a6e22e>Action1a</span>),<span style=color:#a6e22e>Protocol</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>case</span>(<span style=color:#a6e22e>Protocol</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>Protocol2</span>, <span style=color:#a6e22e>Protocol</span>),<span style=color:#a6e22e>SourceIP</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>case</span>(<span style=color:#a6e22e>SourceIP</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>SourceIP2</span>, <span style=color:#a6e22e>SourceIP</span>),<span style=color:#a6e22e>TargetIP</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>case</span>(<span style=color:#a6e22e>TargetIP</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>TargetIP2</span>, <span style=color:#a6e22e>TargetIP</span>),<span style=color:#a6e22e>SourcePort</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>case</span>(<span style=color:#a6e22e>SourcePort</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;N/A&#34;</span>, <span style=color:#a6e22e>SourcePort</span>),<span style=color:#a6e22e>TargetPort</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>case</span>(<span style=color:#a6e22e>TargetPort</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;N/A&#34;</span>, <span style=color:#a6e22e>TargetPort</span>),<span style=color:#a6e22e>NatDestination</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>case</span>(<span style=color:#a6e22e>NatDestination</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;N/A&#34;</span>, <span style=color:#a6e22e>NatDestination</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>TimeGenerated</span>,<span style=color:#a6e22e>Protocol</span>, <span style=color:#a6e22e>SourceIP</span>,<span style=color:#a6e22e>SourcePort</span>,<span style=color:#a6e22e>TargetIP</span>,<span style=color:#a6e22e>TargetPort</span>,<span style=color:#a6e22e>Action</span>, <span style=color:#a6e22e>NatDestination</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>SourceIP</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;10.1.4.25&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>TargetPort</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>22</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>Action</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Deny&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>desc</span> 
</span></span></code></pre></div></p><p>解説 :<br>特定の IP およびポートに対する Azure ファイアウォールの拒否接続 (ネットワーク ルール) を一覧表示する (必要に応じてクエリを変更する)</p></details></div><div><details><summary>NSG フローログ - 送信元 IP に基づいてフローを表示する (必要に応じてクエリを変更する)</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>  <span style=color:#a6e22e>AzureNetworkAnalytics_CL</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>SubType_s</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;FlowLog&#34;</span> 
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>SrcIP_s</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ipaddress&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>DestIP_s</span>, <span style=color:#a6e22e>DestPort_d</span>
</span></span></code></pre></div></p><p>解説 :<br>NSG フローログ - 送信元 IP(ディスプレイ宛先ポートおよび IP)に基づいてフローを表示します。必要に応じて、IP アドレスを置き換えます。</p></details></div><div><details><summary>NSG フローログ - ターゲット IP に基づいてフローを表示する (ディスプレイ ソース ポートと IP)</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureNetworkAnalytics_CL</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>SubType_s</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;FlowLog&#34;</span> 
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>DestIP_s</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ipaddress&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>SrcIP_s</span>, <span style=color:#a6e22e>DestPort_d</span>
</span></span></code></pre></div></p><p>解説 :<br>NSG フローログ - ターゲット IP に基づいてフローを表示する (ディスプレイ ソース ポートと IP)</p></details></div><div><details><summary>バイト単位に基づいて上位 3 つの受信プロセスを調査する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMConnection</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Computer</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;computername&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Received</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesReceived</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>ProcessName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>3</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Received</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>解説 :<br>バイト単位に基づいて上位 3 つの受信プロセスを調査する</p></details></div><div><details><summary>送信バイト数に基づいて上位 3 つの送信プロセスを調査する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMConnection</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Computer</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;computername&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Sent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesSent</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>ProcessName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>3</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Sent</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>解説 :<br>送信バイト数に基づいて上位 3 つの送信プロセスを調査する</p></details></div><div><details><summary>受信バイト数と送信バイト数に基づいて上位 3 つのプロセスを調査する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMConnection</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Computer</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;computername&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Received</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesReceived</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>), <span style=color:#a6e22e>Sent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesSent</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>ProcessName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>TotalMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Received</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>Sent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>SentMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Sent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>ReceivedMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Received</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>ProcessName</span>, <span style=color:#a6e22e>SentMb</span>, <span style=color:#a6e22e>ReceivedMb</span>, <span style=color:#a6e22e>TotalMb</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>3</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TotalMb</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>解説 :<br>受信バイト数と送信バイト数に基づいて上位 3 つのプロセスを調査する</p></details></div><div><details><summary>ネットワークの送信/秒と受信/秒、時間枠の30分平均を示すグラフ</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Perf</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Computer</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;computername&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ObjectName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Network Adapter&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>InstanceName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Microsoft Hyper-V Network Adapter _2&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>CounterValue</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>CounterName</span>, <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>30</span><span style=color:#a6e22e>min</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>desc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span> 
</span></span></code></pre></div></p><p>解説 :<br>ネットワークの送信/秒と受信/秒、時間枠の30分平均を示すグラフ</p></details></div><div><details><summary>受信バイト数と送信バイト数に基づいて上位 3 つの通信パートナーを調査する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMConnection</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Computer</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;computername&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>DNS</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>parse_json</span>(<span style=color:#a6e22e>RemoteDnsQuestions</span>)[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Received</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesReceived</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>), <span style=color:#a6e22e>Sent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesSent</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>DestinationIp</span>, <span style=color:#a6e22e>DNS</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>TotalMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Received</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>Sent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>SentMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Sent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>ReceivedMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Received</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>DestinationIp</span>, <span style=color:#a6e22e>SentMb</span>, <span style=color:#a6e22e>ReceivedMb</span>, <span style=color:#a6e22e>TotalMb</span>, <span style=color:#a6e22e>DNS</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>3</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TotalMb</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>解説 :<br>受信バイト数と送信バイト数に基づいて上位 3 つの通信パートナーを調査する</p></details></div><div><details><summary>受信および送信の通信イベントが最も多い上位 10 台のコンピュータを調査する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMConnection</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Events</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Events</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>解説 :<br>受信および送信の通信イベントが最も多い上位 10 台のコンピュータを調査する</p></details></div><div><details><summary>ほとんどの通信イベントで上位 10 個のポートを調査する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMConnection</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Events</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>DestinationPort</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Events</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>解説 :<br>ほとんどの通信イベントで上位 10 個のポートを調査する</p></details></div><div><details><summary>受信バイト数と送信バイト数に基づいて上位 3 つの通信ポートを調査する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMConnection</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Received</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesReceived</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>), <span style=color:#a6e22e>Sent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesSent</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>DestinationPort</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>TotalMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Received</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>Sent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>SentMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Sent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>ReceivedMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Received</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>DestinationPort</span>, <span style=color:#a6e22e>SentMb</span>, <span style=color:#a6e22e>ReceivedMb</span>, <span style=color:#a6e22e>TotalMb</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>3</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TotalMb</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>解説 :<br>受信バイト数と送信バイト数に基づいて上位 3 つの通信ポートを調査する</p></details></div><div><details><summary>プロセス名に基づいて上位 3 つの通信ポートを調べる</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMConnection</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Received</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesReceived</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>), <span style=color:#a6e22e>Sent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>BytesSent</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>ProcessName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>TotalMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Received</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>Sent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>SentMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Sent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>ReceivedMb</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Received</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>ProcessName</span>, <span style=color:#a6e22e>SentMb</span>, <span style=color:#a6e22e>ReceivedMb</span>, <span style=color:#a6e22e>TotalMb</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>3</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TotalMb</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>解説 :<br>プロセス名に基づいて上位 3 つの通信ポートを調べる</p></details></div><h3 id=compute>Compute</h3><div><details><summary>コンピュータごとに最後のハートビートを取得する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Heartbeat</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>LastHeartBeat</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>arg_max</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#f92672>*</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>
</span></span></code></pre></div></p><p>解説 :<br>Microsoft 監視エージェントがコンピューターに展開されている場合、1 分ごとにハートビートを送信します。このクエリを使用すると、各コンピュータから送信された最後のハートビートを確認できます。</p></details></div><div><details><summary>5分間ハートビートを送っていないコンピュータを取得する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Heartbeat</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>LastHeartBeat</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>arg_max</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#f92672>*</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>LastHeartBeat</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span></code></pre></div></p><p>解説 :<br>5分間ハートビートを送っていないコンピュータを取得する</p></details></div><div><details><summary>過去 4 時間に集計されたすべてのコンピュータのディスク空き容量の割合を確認する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>InsightsMetrics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>4</span><span style=color:#a6e22e>h</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Namespace</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;LogicalDisk&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;FreeSpacePercentage&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>DiskInstance</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>parse_json</span>(<span style=color:#a6e22e>Tags</span>).[<span style=color:#e6db74>&#34;vm.azm.ms/mountId&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>DiskFreeSpace</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>Val</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>4</span><span style=color:#a6e22e>h</span>), <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>DiskInstance</span>
</span></span></code></pre></div></p><p>解説 :<br>VM インサイトを使用する場合、すべてのパフォーマンス カウンターがインサイト メトリック テーブルに収集されます。このクエリは、過去 4 時間に集計されたすべてのディスクの空き領域の割合を示します。</p></details></div><div><details><summary>すべてのコンピュータの更新管理の最新の状態を表示する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>UpdateSummary</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>arg_max</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#f92672>*</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>LastUpdateApplied</span>, <span style=color:#a6e22e>OldestMissingSecurityUpdateInDays</span>, <span style=color:#a6e22e>WindowsUpdateSetting</span>, <span style=color:#a6e22e>SecurityUpdatesMissing</span>, <span style=color:#a6e22e>OtherUpdatesMissing</span>, <span style=color:#a6e22e>RestartPending</span>
</span></span></code></pre></div></p><p>解説 :<br>更新の管理を使用する場合は、このクエリを使用して、各コンピュータの最新の状態を表示できます。</p></details></div><div><details><summary>過去 7 日間の各更新ジョブの状態を表示します</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>UpdateRunProgress</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>7</span><span style=color:#a6e22e>d</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Failed</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>countif</span>(<span style=color:#a6e22e>InstallationStatus</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Failed&#34;</span>), <span style=color:#a6e22e>FailedtoStart</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>countif</span>(<span style=color:#a6e22e>InstallationStatus</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;FailedtoStart&#34;</span>), <span style=color:#a6e22e>InProgress</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>countif</span>(<span style=color:#a6e22e>InstallationStatus</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;InProgress&#34;</span>), <span style=color:#a6e22e>Succeeded</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>countif</span>(<span style=color:#a6e22e>InstallationStatus</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Succeeded&#34;</span>), <span style=color:#a6e22e>NotIncluded</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>countif</span>(<span style=color:#a6e22e>InstallationStatus</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;NotIncluded&#34;</span>), <span style=color:#a6e22e>NotStarted</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>countif</span>(<span style=color:#a6e22e>InstallationStatus</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;NotStarted&#34;</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>UpdateRunName</span>
</span></span></code></pre></div></p><p>解説 :<br>このクエリを使用して、過去 7 日間の各更新ジョブの各ステータスの更新数を確認します。</p></details></div><h3 id=data>Data</h3><div><details><summary>Azure SQL Database: SQL Database で出力可能なカテゴリを表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Category</span>
</span></span></code></pre></div></p><p>解説 :<br>「DatabaseWaitStatistics」カテゴリでは指定した範囲期間内にデータベース内で発生した内部リソースの待機時間の詳細が確認できます。「QueryStoreWaitStatistics」カテゴリではクエリストア内に格納された情報全体からデータベース内で発生した内部リソースの待機時間の詳細が確認できます。「Errors」カテゴリでは発生したエラーを確認できます。</p></details></div><div><details><summary>Azure SQL Database: リソース待機時間の詳細を円グラフで表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;DatabaseWaitStatistics&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>delta_wait_time_ms_d</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>wait_type_s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>sort</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>sum_delta_wait_time_ms_d</span> <span style=color:#a6e22e>desc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>piechart</span> 
</span></span></code></pre></div></p><p>解説 :<br>待機時間の多いリソースに着目することで、データベースのパフォーマンス改善の糸口を発見することができます。</p></details></div><div><details><summary>Azure SQL Database: リソース待機回数の詳細を円グラフで表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;DatabaseWaitStatistics&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>delta_waiting_tasks_count_d</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>wait_type_s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>sort</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>sum_delta_waiting_tasks_count_d</span> <span style=color:#a6e22e>desc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>piechart</span> 
</span></span></code></pre></div></p><p>解説 :<br>待機回数の多いリソースに着目することで、データベースのパフォーマンス改善の糸口を発見することができます。</p></details></div><div><details><summary>Azure SQL Database: クエリストア内に格納されたリソース待機時間情報の詳細を円グラフで表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;QueryStoreWaitStatistics&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>total_query_wait_time_ms_d</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>wait_category_s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>sort</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>sum_total_query_wait_time_ms_d</span> <span style=color:#a6e22e>desc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>piechart</span> 
</span></span></code></pre></div></p><p>解説 :<br>待機時間の多いリソースに着目することで、データベースのパフォーマンス改善の糸口を発見することができます。クエリストア内にはデフォルトで1ヵ月分の情報が格納されるため、より広い範囲での確認が可能です。</p></details></div><div><details><summary>Azure SQL Database: SQL Database で発生したエラーを表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;Errors&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#a6e22e>error_number_d</span>, <span style=color:#a6e22e>Severity</span>, <span style=color:#a6e22e>state_d</span>, <span style=color:#a6e22e>Message</span>
</span></span></code></pre></div></p><p>解説 :<br>データベースで発生したエラーを把握することは顕在化した障害の解決や、潜在的な障害を未然に防止することにつながります。</p></details></div><div><details><summary>Azure SQL Database: SQL Database で発生したエラー数を時系列に折れ線グラフで表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;Errors&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TimeGenerated</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span>  
</span></span></code></pre></div></p><p>解説 :<br>データベースで発生したエラーの回数を把握することは顕在化した障害の解決や、潜在的な障害を未然に防止することにつながります。</p></details></div><div><details><summary>Azure SQL Managed Instance: リソース使用状況を表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ResourceUsageStats&#34;</span>
</span></span></code></pre></div></p><p>解説 :<br>Category オペレーターに &ldquo;ResourceUsageStats&rdquo; を指定することで、Azure SQL Managed Instance の様々なリソースの使用状況を確認することができます。</p></details></div><div><details><summary>Azure SQL Managed Instance: 平均 CPU 使用率、読み込みバイト数、書き込みバイト数を表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ResourceUsageStats&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>avg_cpu_percent_s</span>, <span style=color:#a6e22e>io_bytes_read_s</span>, <span style=color:#a6e22e>io_bytes_written_s</span>
</span></span></code></pre></div></p><p>解説 :<br>秒ごとの CPU 使用率は avg_cpu_percent_s 列、秒ごとの読み取りバイト数は io_bytes_read_s 列、秒ごとの書き込みバイト数は io_bytes_written 列で確認することが可能です。</p></details></div><div><details><summary>Azure SQL Managed Instance: 平均 CPU 使用率、読み込みバイト数、書き込みバイト数の 5 分ごとの平均値を、時刻で並べ替えて昇順に表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ResourceUsageStats&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>sort</span> <span style=color:#a6e22e>by</span>  <span style=color:#a6e22e>asc</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>todouble</span>(<span style=color:#a6e22e>avg_cpu_percent_s</span>)), <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>todouble</span>(<span style=color:#a6e22e>io_bytes_read_s</span>)), <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>todouble</span>(<span style=color:#a6e22e>io_bytes_written_s</span>)) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span></code></pre></div></p><p>解説 :<br>avg_cpu_percent_s 列、io_bytes_read_s 列および io_bytes_written 列は文字列型なので、平均値を求めるために数値型に変換する必要があります。また、時系列で表示するために TimeGenerated で並べ替えを行います。</p></details></div><div><details><summary>Azure SQL Managed Instance: 平均 CPU 使用率、読み込みバイト数、書き込みバイト数の 5 分ごとの平均値を、時刻で昇順に並べ替えて折れ線グラフで表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ResourceUsageStats&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>sort</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>asc</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>todouble</span>(<span style=color:#a6e22e>avg_cpu_percent_s</span>)), <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>todouble</span>(<span style=color:#a6e22e>io_bytes_read_s</span>)), <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>todouble</span>(<span style=color:#a6e22e>io_bytes_written_s</span>)) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span>
</span></span></code></pre></div></p><p>解説 :<br>render オペレーターを timechart キーワードとともに使用して折れ線グラフを表示します。</p></details></div><div><details><summary>Azure Synapse Analytics Dedicated SQL Pool: 過去 30 日の期間内で、実行の時間の長いクエリ上位 20 件を表示してください (クエリ解析 ステップ 1)</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;ExecRequests&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>StatementType_s</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>in</span> (<span style=color:#e6db74>&#39;Batch&#39;</span>,<span style=color:#e6db74>&#39;Execute&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Session_ID</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>SessionId_s</span>),<span style=color:#a6e22e>Request_ID</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>RequestId_s</span>),<span style=color:#a6e22e>Submit_Time</span><span style=color:#f92672>=</span><span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>SubmitTime_t</span>),<span style=color:#a6e22e>Start_Time</span><span style=color:#f92672>=</span><span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>StartTime_t</span>),<span style=color:#a6e22e>End_Time</span><span style=color:#f92672>=</span><span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>EndTime_t</span>),<span style=color:#a6e22e>Command</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>Command_s</span>),<span style=color:#a6e22e>Status</span><span style=color:#f92672>=</span><span style=color:#a6e22e>min</span>(<span style=color:#a6e22e>Status_s</span>), <span style=color:#a6e22e>Statement_Type</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>StatementType_s</span>),<span style=color:#a6e22e>Resource_class</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>ResourceClass_s</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>RequestId_s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>ElapsedTime_min</span><span style=color:#f92672>=</span><span style=color:#a6e22e>anyif</span>((<span style=color:#a6e22e>End_Time</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>Start_Time</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span><span style=color:#a6e22e>m</span>,<span style=color:#a6e22e>Start_Time</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>30</span><span style=color:#a6e22e>d</span>)),<span style=color:#a6e22e>Session_ID</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>Session_ID</span>), <span style=color:#a6e22e>Submit_Time</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>Submit_Time</span>) ,<span style=color:#a6e22e>Start_Time</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>Start_Time</span>), <span style=color:#a6e22e>End_Time</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>End_Time</span>),<span style=color:#a6e22e>Command</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>Command</span>),<span style=color:#a6e22e>Status</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>Status</span>),<span style=color:#a6e22e>Statement_Type</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>Statement_Type</span>),<span style=color:#a6e22e>Resource_class</span><span style=color:#f92672>=</span><span style=color:#a6e22e>any</span>(<span style=color:#a6e22e>Resource_class</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Request_ID</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>ElapsedTime_min</span> <span style=color:#a6e22e>desc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>limit</span> <span style=color:#ae81ff>20</span>
</span></span></code></pre></div></p><p>解説 :<br>Dedicated SQL Poolの ExecRequests カテゴリでは、クエリの実行時間を確認することができます。クエリの実行時間/状態によっては、複数行に渡って一つのクエリの情報が表示されるため、summarize オペレータを使用して必要な情報だけを表示するようにします。処理時間はクエリ終了時間(End_Time)と開始時間(Start_Time)の差から計算しています。より長い期間の確認が必要な場合は ago オペレーターの引数の値を増やしてください (サンプルでは 30d (30日)としています)。また、表示件数を増やす場合は limit オペレーターの値を増やしてください。Request_ID 列の値はステップ 2で使用します。</p></details></div><div><details><summary>Azure Synapse Analytics Dedicated SQL Pool: 分散クエリの各ステップで処理されたデータ件数を表示してください (クエリ解析 ステップ 2)</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span>  <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;RequestSteps&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>RequestId_s</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;QIDnnnnnn&#39;</span> <span style=color:#75715e>//Put your QueryID here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Status_s</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;Running&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>StartTime_t</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>EndTime_t</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>RequestId_s</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>OperationType_s</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>RowCount_d</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>Command_s</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>Status_s</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>StepIndex_d</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>StepIndex_d</span> <span style=color:#a6e22e>asc</span>
</span></span></code></pre></div></p><p>解説 :<br>Dedicated SQL Poolの RequestSteps カテゴリでは、分散クエリの各ステップの情報を取得することができます。一番長く時間がかかっているステップを確認することで、対処方法を検討することができます。解析対象としたいクエリの Request_ID の値 (クエリ解析 ステップ 1にて取得)を、クエリ内で指定してください。</p></details></div><div><details><summary>Azure Synapse Analytics Dedicated SQL Pool: 過去 30 日の期間内で、処理件数の多いクエリステップ上位 20 件を表示してください (クエリ解析 ステップ 3)</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span>  <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;RequestSteps&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>elapsedTime</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>EndTime_t</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>StartTime_t</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>elapsedTime_min</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>elapsedTime</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1</span><span style=color:#a6e22e>m</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>EndTime_t</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>30</span><span style=color:#a6e22e>d</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>StartTime_t</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>30</span><span style=color:#a6e22e>d</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>RowCount_d</span> <span style=color:#a6e22e>desc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>RequestId_s</span>,<span style=color:#a6e22e>OperationType_s</span>, <span style=color:#a6e22e>RowCount_d</span>,<span style=color:#a6e22e>elapsedTime_min</span> , <span style=color:#a6e22e>StartTime_t</span>, <span style=color:#a6e22e>EndTime_t</span>, <span style=color:#a6e22e>Status_s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>limit</span> <span style=color:#ae81ff>20</span>
</span></span></code></pre></div></p><p>解説 :<br>Dedicated SQL Poolの RequestSteps カテゴリでは、分散クエリの各ステップの情報を取得することができます。一番長く時間がかかっているクエリステップを確認することで、対処が必要なクエリの発見が可能です。より長い期間の確認が必要な場合は ago オペレーターの引数の値を増やしてください (サンプルでは 30d (30日)としています)。また、表示件数を増やす場合は limit オペレーターの値を増やしてください。Request_ID 列の値はステップ 4で使用します。</p></details></div><div><details><summary>Azure Synapse Analytics Dedicated SQL Pool: 処理件数が多い分散クエリステップのクエリ全体の処理時間を表示してください (クエリ解析 ステップ 4)</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span>  <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;RequestSteps&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>RequestId_s</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;QIDnnnnn&#39;</span> <span style=color:#75715e>//Insert your QID here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Status_s</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;Running&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>StartTime_t</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>EndTime_t</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>RequestId_s</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>OperationType_s</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>RowCount_d</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>Command_s</span>),<span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>Status_s</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>StepIndex_d</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>StepIndex_d</span> <span style=color:#a6e22e>asc</span>
</span></span></code></pre></div></p><p>解説 :<br>Dedicated SQL Poolの ExecRequests カテゴリでは、クエリ処理状況を確認することができます。解析対象としたいクエリの Request_ID の値 (クエリ解析 ステップ 2にて取得)を、クエリ内で指定してください。</p></details></div><h3 id=avd>AVD</h3><div><details><summary>AVD の診断ログが格納されているテーブルを一覧で表示</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>search</span> <span style=color:#f92672>*</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>$table</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>$table</span> <span style=color:#a6e22e>startswith</span> <span style=color:#e6db74>&#34;WVD&#34;</span>
</span></span></code></pre></div></p><p>解説 :<br>AVD に関連する診断ログは用途毎に別々のテーブルに出力されます。ここでは AVD に関連するテーブルの一覧（ログが 24 時間以内に出力されたものに限る）を表示しています。
AVD の診断ログについては以下のドキュメントを参照ください。<br><a href=https://docs.microsoft.com/ja-jp/azure/virtual-desktop/diagnostics-log-analytics>https://docs.microsoft.com/ja-jp/azure/virtual-desktop/diagnostics-log-analytics</a></p></details></div><div><details><summary>過去 24 時間のアクティブなセッション数の推移を 5 分刻みでグラフ化</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDAgentHealthStatus</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>TotalActiveSessions</span><span style=color:#f92672>=</span><span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>toint</span>(<span style=color:#a6e22e>ActiveSessions</span>))<span style=color:#f92672>/</span><span style=color:#ae81ff>10</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span> 
</span></span></code></pre></div></p><p>解説 :<br>AVD Agent は 30 秒おきにホスト上のアクティブなセッション数などのステータス情報を &lsquo;WVDAgentHealthStatus&rsquo; テーブルに送信しています。
このクエリはアクティブなセッションの数を sum() 関数により集計してグラフ化しています。</p></details></div><div><details><summary>過去 24 時間のインアクティブなセッション数の推移を 5 分刻みでグラフ化</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDAgentHealthStatus</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>TotalInactiveSessions</span><span style=color:#f92672>=</span><span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>toint</span>(<span style=color:#a6e22e>InactiveSessions</span>))<span style=color:#f92672>/</span><span style=color:#ae81ff>10</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span> 
</span></span></code></pre></div></p><p>解説 :<br>インアクティブ（ユーザーが x ボタンで閉じるなどしてアクティブではないがセッションが残っているもの）なセッション数を sum() 関数により集計してグラフ化しています。</p></details></div><div><details><summary>セッションホスト毎のアクティブとインアクティブなセッション数を表示</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDAgentHealthStatus</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>10</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>arg_max</span>(<span style=color:#a6e22e>TimeGenerated</span>,<span style=color:#f92672>*</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>SessionHostName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>SessionHostName</span>, <span style=color:#a6e22e>ActiveSessions</span>, <span style=color:#a6e22e>InactiveSessions</span>, <span style=color:#a6e22e>TimeGenerated</span>
</span></span></code></pre></div></p><p>解説 :<br>現時点（過去 10 分以内）で正常稼働しているセッションホストから、アクティブ／インアクティブなセッション数をホスト毎に表示</p></details></div><div><details><summary>過去 24 時間以内に発生した AVD コントロールプレーンに起因する可能性のあるエラーを表示</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDErrors</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>) 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ServiceError</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;true&#34;</span> 
</span></span></code></pre></div></p><p>解説 :<br>ServiceError カラムが true となっているエラーのみをフィルター表示しています。これらのエラーはマイクロソフト サポートへの問い合わせが必要な問題が発生していることを示しています</p></details></div><div><details><summary>過去 24 時間以内に発生したエラーの数を種類ごとに集計</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDErrors</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>) 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ServiceError</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;false&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>NumOfErrors</span><span style=color:#f92672>=</span><span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>ActivityType</span>, <span style=color:#a6e22e>Source</span>, <span style=color:#a6e22e>CodeSymbolic</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>sort</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Source</span>
</span></span></code></pre></div></p><p>Description :<br></p></details></div><div><details><summary>過去 24 時間以内に発生したエラーの数をユーザー毎に集計</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDErrors</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>) 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ServiceError</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;false&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>NumOfErrors</span><span style=color:#f92672>=</span><span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>UserName</span>
</span></span></code></pre></div></p><p>Description :<br></p></details></div><div><details><summary>過去 24 時間以内に &lt;<em>User UPN</em>> に指定したユーザーで発生したエラーの一覧を表示</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDErrors</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>) 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ServiceError</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;false&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>UserName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&lt;User UPN&gt;&#34;</span>
</span></span></code></pre></div></p><p>Description :<br></p></details></div><div><details><summary>過去 24 時間におけるホストプール毎の接続元 IP アドレスを表示</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDConnections</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>Multi</span><span style=color:#f92672>=</span><span style=color:#a6e22e>split</span>(<span style=color:#a6e22e>_ResourceId</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>HostPool</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>Multi</span>[<span style=color:#ae81ff>8</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>ClientSideIPAddress</span>, <span style=color:#a6e22e>HostPool</span>
</span></span></code></pre></div></p><p>Description :<br></p></details></div><div><details><summary>過去 24 時間の &lt;<em>Host Pool</em>> で指定したホストプールにおけるユーザー毎の接続時間を表示</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDConnections</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>)  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>Multi</span><span style=color:#f92672>=</span><span style=color:#a6e22e>split</span>(<span style=color:#a6e22e>_ResourceId</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>HostPool</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>Multi</span>[<span style=color:#ae81ff>8</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>HostPool</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&lt;Host Pool&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>State</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Connected&#34;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>CorrelationId</span>, <span style=color:#a6e22e>UserName</span>, <span style=color:#a6e22e>StartTime</span><span style=color:#f92672>=</span><span style=color:#a6e22e>TimeGenerated</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span><span style=color:#a6e22e>inner</span>(<span style=color:#a6e22e>WVDConnections</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>State</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Completed&#34;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>EndTime</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#a6e22e>CorrelationId</span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>CorrelationId</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>Duration</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>EndTime</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>StartTime</span>, <span style=color:#a6e22e>UserName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>ConnectionTimeTotal</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>Duration</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>UserName</span>
</span></span></code></pre></div></p><p>解説 :<br>&lsquo;WVDConnections&rsquo; テーブルにはユーザーによる接続開始や切断のログが記録されます。
このクエリではセッションホストに接続してから切断するまでの時間を集計して、ユーザー毎の接続時間の累計値を算出しています。
同じセッションにおける接続と切断のログは &lsquo;CorrelationId&rsquo; が一致するため、join により接続と切断のログを一つのレコードに纏めています。</p></details></div><div><details><summary>過去 1 週間の &lt;<em>Host Pool</em>> で指定したホストプールにおけるユーザー毎の接続時間の推移を表示</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDConnections</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>7</span><span style=color:#a6e22e>d</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>Multi</span><span style=color:#f92672>=</span><span style=color:#a6e22e>split</span>(<span style=color:#a6e22e>_ResourceId</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>HostPool</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>Multi</span>[<span style=color:#ae81ff>8</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>HostPool</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&lt;Host Pool&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>State</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Connected&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>CorrelationId</span>, <span style=color:#a6e22e>UserName</span>, <span style=color:#a6e22e>StartTime</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>TimeGenerated</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span><span style=color:#a6e22e>inner</span>(<span style=color:#a6e22e>WVDConnections</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>State</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Completed&#34;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>EndTime</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#a6e22e>CorrelationId</span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>CorrelationId</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>DurationInMinutes</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>EndTime</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>StartTime</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span><span style=color:#a6e22e>m</span>, <span style=color:#a6e22e>UserName</span>, <span style=color:#a6e22e>EndTime</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>ConnectionTimeInMinutes</span><span style=color:#f92672>=</span><span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>DurationInMinutes</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>EndTime</span>, <span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>), <span style=color:#a6e22e>UserName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span>
</span></span></code></pre></div></p><p>解説 :<br>上に書いたクエリーを拡張して、ユーザー毎の接続時間の日次推移をグラフ化しています。
datetime 型同士で引き算をすると timespan 型になりますが、この型のままではグラフ化できないため、11 行目で &lsquo;1m&rsquo; で割ることで分単位のスカラー値に変換しています。</p></details></div><div><details><summary>過去 24 時間におけるセッションホストとクライアント デバイス間の応答性（レイテンシ）をホストプール毎に表示</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDConnectionNetworkData</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>Multi</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>split</span>(<span style=color:#a6e22e>_ResourceId</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>HostPool</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>Multi</span>[<span style=color:#ae81ff>8</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>EstRoundTripTimeInMs</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>10</span><span style=color:#a6e22e>m</span>), <span style=color:#a6e22e>HostPool</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span> 
</span></span></code></pre></div></p><p>解説 :<br>&lsquo;WVDConnectionNetworkData&rsquo; テーブルにはセッションホスト接続時の応答性（レイテンシ）の情報が記録されます。
このクエリでは過去 24 時間におけるホストプール毎のレイテンシの推移を、10 分毎の平均値として表示しています。</p></details></div><div><details><summary>過去 24 時間におけるセッションホストとクライアント デバイス間の応答性（レイテンシ）を &lt;<em>User UPN</em>> で指定したユーザーについて表示</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>WVDConnectionNetworkData</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>24</span><span style=color:#a6e22e>h</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span><span style=color:#a6e22e>inner</span> (<span style=color:#a6e22e>WVDConnections</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>CorrelationId</span>, <span style=color:#a6e22e>UserName</span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>CorrelationId</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>UserName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&lt;User UPN&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>EstRoundTripTimeInMs</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>10</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span> 
</span></span></code></pre></div></p><p>解説 :<br>このクエリでは過去 24 時間の特定のユーザーにおけるレイテンシの推移を、10 分毎の平均値として表示しています。</p></details></div><h3 id=application-insights>Application Insights</h3><div><details><summary>過去12時間のリクエストを集計してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>requests</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>timestamp</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>12</span><span style=color:#a6e22e>h</span>) 
</span></span></code></pre></div></p><p>解説 :<br><code>requests</code> テーブルは、Application Insights で収集したHTTPリクエストのテーブルです。</p></details></div><div><details><summary>過去12時間の失敗したリクエストを集計してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>requests</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>timestamp</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>12</span><span style=color:#a6e22e>h</span>) 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>success</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>false</span>
</span></span></code></pre></div></p><p>解説 :<br><code>requests</code> テーブルの中には、<code>sucess</code> という <code>boolean</code> 型の行があります。 <code>success</code> を <code>false</code> に設定することによって失敗したリクエストを集計することができます。</p></details></div><div><details><summary>リクエストのパフォーマンスを平均、50、95、99パーセンタイルで集計してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>requests</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>RequestsCount</span><span style=color:#f92672>=</span><span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>itemCount</span>), <span style=color:#a6e22e>AverageDuration</span><span style=color:#f92672>=</span><span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>duration</span>), <span style=color:#a6e22e>percentiles</span>(<span style=color:#a6e22e>duration</span>, <span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>95</span>, <span style=color:#ae81ff>99</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>operation_Name</span>
</span></span></code></pre></div></p><p>解説 :<br><code>requests</code> テーブルの中には、<code>duration</code> という 返答にかかった時間を表すデータがあります。 <code>avg</code> を使えば平均を、<code>percentiles</code> を使えばパーセンタイルでの集計が可能です。</p></details></div><div><details><summary>リクエストからアクセス元の国トップ10を表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>requests</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>CountByCountry</span><span style=color:#f92672>=</span><span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>client_CountryOrRegion</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>CountByCountry</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>piechart</span>
</span></span></code></pre></div></p><p>Description :<br>NA</p></details></div><div><details><summary>ページビューのデータを表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>pageViews</span>
</span></span></code></pre></div></p><p>解説 :<br>ページビューを集計するためには、<code>pageViews</code> のテーブルを使います。</p></details></div><div><details><summary>ブラウザから参照されるページビューのデータを表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>pageViews</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>client_type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;Browser&#39;</span>
</span></span></code></pre></div></p><p>解説 :<br><code>pageViews</code> テーブルの中に <code>client_type</code> のデータがあります。<code>where</code> 句を使い <code>client_type</code> を Browser に絞ることでブラウザから参照されるデータを抽出できます。</p></details></div><div><details><summary>ブラウザから参照されるページビューのデータを使い、処理にかかった時間を集計し、トップ10とその平均値を表示してください。</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>pageViews</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>notempty</span>(<span style=color:#a6e22e>duration</span>) <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>client_Type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;Browser&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>total_duration</span><span style=color:#f92672>=</span><span style=color:#a6e22e>duration</span><span style=color:#f92672>*</span><span style=color:#a6e22e>itemCount</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>avg_duration</span><span style=color:#f92672>=</span>(<span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>total_duration</span>)<span style=color:#f92672>/</span><span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>itemCount</span>)) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>operation_Name</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>avg_duration</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>解説 :<br><code>where</code> 句で <code>duration</code> が空でないものでかつブラウザからのアクセスのものを区切り、<code>extend</code> 句で処理時間の合計値として <code>total_duration</code> を計算します。
<code>sumamrize</code> 句で アクセスディレクトリのデータである <code>operation_Name</code> 事に平均処理時間を出します。最後に <code>top</code> 句を使い平均処理時間のトップ10を出し <code>desc</code> で並べかえます。</p></details></div><h3 id=security>Security</h3><div><details><summary>同一のユーザーに対する連続的なログオンの失敗を検出する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>threshold</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>unit</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span><span style=color:#a6e22e>m</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>SigninLogs</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ResultType</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>in</span> (<span style=color:#e6db74>&#34;0&#34;</span>, <span style=color:#e6db74>&#34;50125&#34;</span>, <span style=color:#e6db74>&#34;50140&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>loginfailure</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>UserPrincipalName</span>, <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>,<span style=color:#a6e22e>unit</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>loginfailure</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>threshold</span> 
</span></span></code></pre></div></p><p>解説 :<br><p>このクエリはブルートフォース攻撃を検出するためのサンプルです。<br>SigninLogs テーブルから <code>unit</code> に設定した時間内に <code>threshold</code> で設定した回数を超えるサインインの失敗を検出します。<br>ResultType にサインインの結果が含まれ、0 はサインインが成功し問題がないことを表します。50125 と 50140 はそれぞれパスワードがリセットされた場合とサインインの記憶を設定した場合に記録されるイベントで、頻繁に発生する可能性のある失敗ではないイベントです。</p><p>SigninLogs は Azure AD に対するユーザーなどのサインインを記録します。このログは Azure AD の診断設定から有効化することができ、有効化には Azure AD Premium P1 または P2 のライセンスが必要です。
これらのコードは将来変更される可能性がありますが、の詳細は <a href=https://docs.microsoft.com/azure/active-directory/develop/reference-aadsts-error-codes>Azure AD 認証と承認のエラー コード</a> に記載がある他、<a href=https://login.microsoftonline.com/error>https://login.microsoftonline.com/error</a> でコードに対応するメッセージを確認することができます。</p></p></details></div><div><details><summary>異なるユーザーに対する連続的なログオンの失敗を検出する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>threshold</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>unit</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span><span style=color:#a6e22e>m</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>SigninLogs</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ResultType</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>in</span> (<span style=color:#e6db74>&#34;0&#34;</span>, <span style=color:#e6db74>&#34;50125&#34;</span>, <span style=color:#e6db74>&#34;50140&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>loginfailure</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dcount</span>(<span style=color:#a6e22e>UserPrincipalName</span>) <span style=color:#a6e22e>by</span>  <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>,<span style=color:#a6e22e>unit</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>loginfailure</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>threshold</span> 
</span></span></code></pre></div></p><p>解説 :<br>このクエリはパスワード スプレー攻撃を検出するためのサンプルです。
ブルート フォースは特定のユーザーに複数のパスワードを試行する攻撃ですが、アカウントのロックなどで回避・検出が行われやすいため、パスワードスプレーではパスワードをよく使われやすいものに固定し、ユーザーを変えながらサインインを試行します。
このクエリでは <code>unit</code> で指定した時間内に記録されたユニークなユーザーによるサインインの失敗を数え、閾値を越えたものを検出します。</p></details></div><div><details><summary>Application Gateway で過去に記録されたエラーの数が閾値より多いクライアントの IP アドレスを表示する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>threshold</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>lookback</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span><span style=color:#a6e22e>m</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#a6e22e>lookback</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ApplicationGatewayAccessLog&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>httpStatus_d</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>300</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>ErrCount</span><span style=color:#f92672>=</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>clientIP_s</span>,<span style=color:#a6e22e>userAgent_s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ErrCount</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>threshold</span>
</span></span></code></pre></div></p><p>解説 :<br>ApplicationGateway は複数のログを生成します。一つはクライアントからアプリケーションのアクセスがあったことを記録する ApplicationGatewayAccessLog カテゴリで、IP アドレスやユーザーエージェント文字列、アクセス先のアプリケーションの URI とアクセス結果の HTTP ステータスなどが記録されています。このログは AzureDiagnostics の ApplicationGatewayAccessLog カテゴリに記録されます。<br>偵察のフェーズでは HTTP のステータスコードでエラーが記録されることが多いため、ステータスコードがエラー (300) 以上のレコードをフィルタします。予め設定された閾値を上回るエラーを記録した IP アドレスを検出することで偵察と思われるアクセスを発見します。
このクエリはバックエンドのサービスに障害が発生しているようなケースを誤検出する可能性があり、また拠点から複数のユーザーが１つのゲートウェイを経由してインターネットアクセスを行うようなケースでも、同一 IP アドレスからの発信元とみなされるためうまく動作しない可能性があります。緩和策として IP アドレスの他にも UserAgent_s でユーザーエージェント文字列によりアクセス元を区別するようにしていますが、十分ではありません。</p></details></div><div><details><summary>Application Gateway で複数のアプリケーションに対してアクセスエラーとなっているクライアント IP アドレスを表示する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>threshold</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>lookback</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span><span style=color:#a6e22e>m</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#a6e22e>lookback</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ApplicationGatewayAccessLog&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>httpStatus_d</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>300</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>UriCount</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dcount</span>(<span style=color:#a6e22e>requestUri_s</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>clientIP_s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>UriCount</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>threshold</span>
</span></span></code></pre></div></p><p>解説 :<br>偵察フェーズではパスの総当たりや脆弱性のあるアプリケーションを確認するために複数のアプリケーションのパスに対してアクセスを行うことがあります。この結果単位時間内に複数の requestUri_s に対してエラーが発生します。
dcount は指定された列に対してユニークな数をカウントする関数で、このクエリでは clientIP_s に対してユニークな requestUri_s の数、つまり特定の clientIP_s からアクセスが試行されたアプリケーションの数が集計されます。
レコード httpStatus_d がエラーになるものにフィルタされているため、ある IP からアクセスに失敗したアプリケーションの数を閾値と比較して攻撃を検出することができます。<br>実際の攻撃では発信元 IP が複数に分散している場合もあるので注意が必要です。</p></details></div><div><details><summary>Application Gateway で複数回のアクセス エラーの後にアプリケーションのアクセスに成功したクライアントの IP アドレスを表示する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>lookback</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span><span style=color:#a6e22e>m</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>threshold</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>SuccessIPs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#a6e22e>lookback</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ApplicationGatewayAccessLog&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>httpStatus_d</span> <span style=color:#a6e22e>between</span> (<span style=color:#ae81ff>200</span> .. <span style=color:#ae81ff>299</span>) 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>AccessTime</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>TimeGenerated</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>clientIP_s</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#a6e22e>lookback</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>httpStatus_d</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>300</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span><span style=color:#a6e22e>inner</span> <span style=color:#a6e22e>SuccessIPs</span> <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>clientIP_s</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>AccessTime</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>ErrBeforeSuccess</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>clientIP_s</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ErrBeforeSuccess</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>threshold</span>
</span></span></code></pre></div></p><p>解説 :<br>偵察フェーズではエラーが発生することが多いですが、エラーが続いたあとに HTTP のアクセス成功コードがかえる場合、アプリケーションの不正なアクセスに成功している可能性があります。
このクエリでは ApplicationGatewayAccessLog から IP アドレスごとにアクセスに成功した最後の時刻のデータセットを作成し、元の ApplicationGatewayAccessLog からエラーだけを抽出したデータセットと join します。
アクセスに成功した時刻が AccessTime 列に含まれるため、TimeGenerated がこれより小さい（古い）レコードを数え、アクセス成功前に閾値を超える回数エラーが発生していたことを検出します。</p></details></div><div><details><summary>Web Application Firewall で検出した攻撃を表示する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span><span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ApplicationGatewayFirewallLog&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>TimeGenerated</span>,<span style=color:#a6e22e>clientIp_s</span>,<span style=color:#a6e22e>hostname_s</span>,<span style=color:#a6e22e>requestUri_s</span>,<span style=color:#a6e22e>ruleSetVersion_s</span>,<span style=color:#a6e22e>ruleId_s</span>,<span style=color:#a6e22e>Message</span>,<span style=color:#a6e22e>details_message_s</span>,<span style=color:#a6e22e>details_data_s</span>
</span></span></code></pre></div></p><p>解説 :<br>WAF が有効な場合 ApplicationGatewayFirewallLog カテゴリに WAF のルールによる検出結果を記録することができます。このクエリでは WAF のルール検出の際によく使う項目を表示しています。</p></details></div><div><details><summary>AzureActivity で過去１か月に発生していなかった新しい管理操作を検出する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>past1month</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>AzureActivity</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>30</span><span style=color:#a6e22e>d</span>) .. <span style=color:#a6e22e>startofday</span>(<span style=color:#a6e22e>now</span>()))
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>CategoryValue</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Administrative&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span>  <span style=color:#a6e22e>OperationNameValue</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>AzureActivity</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span>  <span style=color:#a6e22e>startofday</span>(<span style=color:#a6e22e>now</span>())
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>CategoryValue</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Administrative&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>OperationNameValue</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>in</span> (<span style=color:#a6e22e>past1month</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#a6e22e>OperationNameValue</span>, <span style=color:#a6e22e>OperationName</span>, <span style=color:#a6e22e>ResourceGroup</span>, <span style=color:#a6e22e>ResourceProviderValue</span>, <span style=color:#a6e22e>Caller</span>
</span></span></code></pre></div></p><p>解説 :<br>Administrative テーブルは <code>Administrative</code> に管理操作を記録します。システムの変更が発生していないときには管理操作は一定のものが記録されますが、急に記録されていない新しい操作が記録された場合には、新しく変更作業が発生したか、セキュリティ侵害の兆候の可能性があります。</p></details></div><div><details><summary>他のコンピューターでは起動していないプロセスを持つコンピューターを表示する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMProcess</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>UniqueProcesses</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dcount</span>(<span style=color:#a6e22e>Computer</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>ExecutableName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>UniqueProcesses</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> (
</span></span><span style=display:flex><span><span style=color:#a6e22e>VMProcess</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>ExecutableName</span>, <span style=color:#a6e22e>ExecutablePath</span>
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>ExecutableName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>ExecutableName</span>, <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>ExecutablePath</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>ExecutableName</span>
</span></span></code></pre></div></p><p>解説 :<br>サーバー ワークロードでは同じ役割のコンピューターでは同じプロセスが起動することになるため、ユニークなプロセスが起動している場合には何か特殊な操作を行っている可能性があります。
これは何らかの変更作業に伴うものである可能性もありますし、セキュリティ侵害を示唆するものである可能性もあります。</p></details></div><div><details><summary>Secuire Score の１週間の変化を確認する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>SecureScores</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>7</span><span style=color:#a6e22e>d</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>SecureScorePercentage</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>PercentageScore</span><span style=color:#f92672>*</span><span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>AverageScore</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>SecureScorePercentage</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>1</span><span style=color:#a6e22e>d</span>)
</span></span></code></pre></div></p><p>解説 :<br>セキュリティ スコアは無償で利用することができる Microsoft Defender for Cloud のポスチャ マネジメントの機能です。
Azure Policy を使用して、マイクロソフトの推奨設定が行われているかをチェックします。
ワークロードの追加や更新プログラムのリリースにより日々変化するため、90% 以上を維持するようにメンテナンスしましょう。</p></details></div><div><details><summary>ApplicationGateway のバックエンド プールのリソースからのデータ送信を検出する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>backend</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ApplicationGatewayAccessLog&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>serverRouted_s</span> <span style=color:#f92672>&lt;&gt;</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>serverRouted_s</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;AzureFirewallNetworkRule&#34;</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;AzureFirewallApplicationRule&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#66d9ef>with</span> <span style=color:#f92672>*</span>  <span style=color:#e6db74>&#34; request from &#34;</span> <span style=color:#a6e22e>SourceIP</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#a6e22e>SourcePort</span> <span style=color:#e6db74>&#34; to &#34;</span> <span style=color:#a6e22e>Dest</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#a6e22e>DestPort</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>TimeGenerated</span>,<span style=color:#a6e22e>SourceIP</span>,<span style=color:#a6e22e>SourcePort</span>,<span style=color:#a6e22e>Dest</span>,<span style=color:#a6e22e>DestPort</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>SourceIP</span> <span style=color:#66d9ef>in</span> (<span style=color:#a6e22e>backend</span>)
</span></span></code></pre></div></p><p>解説 :<br>アプリケーションゲートウェイのバックエンドに対する通信は Web Applicaiton Firewall によって件さされますが、検出されなかった攻撃のペイロードはバックエンドが受け取る可能性があります。
ペイロードは様々な動作をすることが考えられますが、インターネット上の C&C サーバーと通信を行うためにアウトバウンドのデータ通信を発生させるものがあります。<br>このクエリでは Azure Firewall が使われていて、全てのインターネット向け通信は Azure Firewall にルーティングされるように構成されている環境を想定しています。
pplicationGateway のバックエンド サーバーの IP アドレスは serverRouted_s に記録されるため、serverRouted_s のリストを作成します。
Azure Firewall では IP ベースのネットワークルール、URL ベースのアプリケーション ルールともに送信元アドレスが記録されるため、送信元アドレスが予め作成したバックエンドのリストと一致するものがデータ送信を行おうとしたバックエンドです。</p></details></div><div><details><summary>コンピューターに対して対話的ログインを行ったユーザーを表示する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>SecurityEvent</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>EventID</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>4624</span> <span style=color:#a6e22e>and</span> (<span style=color:#a6e22e>LogonType</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>LogonType</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>10</span>) <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>AccountType</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;User&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>Account</span>
</span></span></code></pre></div></p><p>解説 :<br>一般的に運用中のサーバーには、変更管理の期間を除き対話的ログオンが発生することはありません。
SecurityEvent は Windows のセキュリティ ログが記録されますが対話的ログインのイベントを検出することで簡単なセキュリティ監視を実装することができます。
SecurityEvent を取得するためには Defender for Cloud の有償 SKU が必要です。</p></details></div><div><details><summary>脅威インテリジェンスに含まれる IP アドレスへの送信アクセスを検出する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>maliciousIPs</span> <span style=color:#f92672>=</span> 
</span></span><span style=display:flex><span><span style=color:#a6e22e>ThreatIntelligenceIndicator</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>NetworkIP</span> <span style=color:#f92672>&lt;&gt;</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>Active</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>true</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>ExpirationDateTime</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>now</span>()
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>NetworkIP</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;AzureFirewallNetworkRule&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>msg_s</span> <span style=color:#66d9ef>with</span> <span style=color:#f92672>*</span>  <span style=color:#e6db74>&#34; request from &#34;</span> <span style=color:#a6e22e>SourceIP</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#a6e22e>SourcePort</span> <span style=color:#e6db74>&#34; to &#34;</span> <span style=color:#a6e22e>DestIP</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#a6e22e>DestPort</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>DestIP</span>  <span style=color:#66d9ef>in</span> (<span style=color:#a6e22e>maliciousIPs</span>)
</span></span></code></pre></div></p><p>解説 :<br>このクエリを実行するためには Azure Sentinel が必要です。Azure Sentinel では様々なデータソースからログを連携するためのデータコネクタがあり、脅威インテリジェンス（信頼できないIP、URL、ファイルハッシュなど）を取り込むことができます。
この例では脅威インテリジェンスから得られたアクティブな信頼できない IP アドレスに対して Azure Firewall のログを照会し、あやしい外部アクセスがあるかどうかを確認しています。</p></details></div><h3 id=resource-graph>Resource Graph</h3><div><details><summary>View subscriptions with no Key Vaults</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>ResourceContainers</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>==</span><span style=color:#e6db74>&#39;microsoft.resources/subscriptions&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>id</span> <span style=color:#66d9ef>with</span> <span style=color:#e6db74>&#34;/subscriptions/&#34;</span> <span style=color:#a6e22e>SubscriptionID</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>subscriptionId</span>, <span style=color:#a6e22e>SubscriptionName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span><span style=color:#a6e22e>leftouter</span> (
</span></span><span style=display:flex><span><span style=color:#a6e22e>Resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;microsoft.keyvault/vaults&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>subscriptionId</span>
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>subscriptionId</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span> <span style=color:#a6e22e>leftouter</span> (
</span></span><span style=display:flex><span><span style=color:#a6e22e>Resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;microsoft.keyvault/vaults&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>ResourceCount</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>subscriptionId</span>
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>subscriptionId</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>RCount</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>iff</span>(<span style=color:#a6e22e>isnull</span>(<span style=color:#a6e22e>ResourceCount</span>), <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>ResourceCount</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span><span style=color:#f92672>-</span><span style=color:#a6e22e>away</span> <span style=color:#a6e22e>ResourceCount</span>, <span style=color:#a6e22e>subscriptionId1</span>, <span style=color:#a6e22e>subscriptionId2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>HealthStatus</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>iff</span>(<span style=color:#a6e22e>RCount</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#34;Not Compliant&#34;</span>, <span style=color:#e6db74>&#34;Compliant&#34;</span>)
</span></span></code></pre></div></p><p>Description :<br>You can use this query in Azure Resource Graph to identify any subscriptions that do not contain KeyVaults.</p></details></div><div><details><summary>View status of Azure Monitor Agents for all virtual machines</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.compute/virtualmachines&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>ComputerName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>subscriptionId</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span><span style=color:#a6e22e>leftouter</span>  (
</span></span><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.compute/virtualmachines/extensions&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>name</span> <span style=color:#66d9ef>in</span> (<span style=color:#e6db74>&#34;AzureMonitorLinuxAgent&#34;</span>, <span style=color:#e6db74>&#34;AzureMonitorWindowsAgent&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>id</span> <span style=color:#66d9ef>with</span> <span style=color:#f92672>*</span> <span style=color:#e6db74>&#34;/virtualMachines/&#34;</span> <span style=color:#a6e22e>ComputerName</span> <span style=color:#e6db74>&#34;/extensions/&#34;</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>AMAStatus</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>provisioningState</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WorkspaceID</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>workspaceId</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>AMA</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>ComputerName</span>, <span style=color:#a6e22e>AMAStatus</span>
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>ComputerName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span><span style=color:#a6e22e>leftouter</span>  (
</span></span><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.compute/virtualmachines/extensions&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>name</span> <span style=color:#66d9ef>in</span> (<span style=color:#e6db74>&#34;MicrosoftMonitoringAgent&#34;</span>, <span style=color:#e6db74>&#34;OmsAgentForLinux&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>id</span> <span style=color:#66d9ef>with</span> <span style=color:#f92672>*</span> <span style=color:#e6db74>&#34;/virtualMachines/&#34;</span> <span style=color:#a6e22e>ComputerName</span> <span style=color:#e6db74>&#34;/extensions/&#34;</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>MMAStatus</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>provisioningState</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WorkspaceID</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>workspaceId</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>MMA</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>ComputerName</span>, <span style=color:#a6e22e>MMAStatus</span>, <span style=color:#a6e22e>WorkspaceID</span>
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>ComputerName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span><span style=color:#a6e22e>leftouter</span>  (
</span></span><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.operationalinsights/workspaces&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>WorkspaceID</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>customerId</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>WorkspaceName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>WorkspaceID</span>
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>WorkspaceID</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span><span style=color:#f92672>-</span><span style=color:#a6e22e>away</span> <span style=color:#a6e22e>WorkspaceID1</span>, <span style=color:#a6e22e>ComputerName1</span>, <span style=color:#a6e22e>ComputerName2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> [<span style=color:#e6db74>&#34;Both Agents&#34;</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>iff</span>(<span style=color:#a6e22e>isnotempty</span>(<span style=color:#a6e22e>AMA</span>) <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>isnotempty</span>(<span style=color:#a6e22e>MMA</span>), <span style=color:#e6db74>&#34;True&#34;</span>, <span style=color:#e6db74>&#34;False&#34;</span>)
</span></span></code></pre></div></p><p>Description :<br>You can use this query in Azure Resource Graph to identify which virtual machines have both the Azure Monitor Agent and the Microsoft Monitoring Agent deployed, and which workspace the MMA reports to.</p></details></div><div><details><summary>View Orphan Managed disks</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>=~</span> <span style=color:#e6db74>&#39;microsoft.compute/Disks&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>managedBy</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>id</span>
</span></span></code></pre></div></p><p>Description :<br>You can use this query in Azure Resource Graph to identify any orphaned disks.</p></details></div><div><details><summary>View Orphaned NICs</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.network/networkinterfaces&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>isnull</span> (<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>virtualMachine</span>) <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>isnull</span> (<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>privateEndpoint</span>)
</span></span></code></pre></div></p><p>Description :<br>This query can be used in Azure Resource Graph to identify any detached NIC</p></details></div><div><details><summary>View Orphaned NSGs</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>=~</span> <span style=color:#e6db74>&#39;microsoft.network/networksecuritygroups&#39;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>isnull</span>(<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>networkInterfaces</span>) <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>isnull</span>(<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>subnets</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>resourceGroup</span>
</span></span></code></pre></div></p><p>Description :<br>This query can be used in Azure Resource Graph to identify any used Network Security Group</p></details></div><div><details><summary>View Orphaned Route Tables</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.network/routetables&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>isnull</span>(<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>subnets</span>)
</span></span></code></pre></div></p><p>Description :<br>This query can be used in Azure Resource Graph to identify any unused route table</p></details></div><div><details><summary>Show Storage accounts with public endpoints</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.storage/storageaccounts&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>allowBlobPublicAccess</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;true&#39;</span>
</span></span></code></pre></div></p><p>Description :<br>This query can be used in Azure Resource Graph to identify any storage account with public endpoints</p></details></div><div><details><summary>Show Storage accounts with non-encrypted transfers enabled</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>  <span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.storage/storageaccounts&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>allowBlobPublicAccess</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;true&#39;</span>        
</span></span></code></pre></div></p><p>Description :<br>This query can be used in Azure Resource Graph to identify any storage accounts without an https requirement</p></details></div><div><details><summary>VNets: Peering Configuration</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> [<span style=color:#e6db74>&#39;type&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;microsoft.network/virtualnetworks&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>mv</span><span style=color:#f92672>-</span><span style=color:#a6e22e>expand</span> <span style=color:#a6e22e>peerings</span><span style=color:#f92672>=</span><span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>virtualNetworkPeerings</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>VNetName</span><span style=color:#f92672>=</span><span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>peeringName</span><span style=color:#f92672>=</span><span style=color:#a6e22e>peerings</span>.<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>peeringTarget</span><span style=color:#f92672>=</span><span style=color:#a6e22e>split</span>(<span style=color:#a6e22e>peerings</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>remoteVirtualNetwork</span>.<span style=color:#a6e22e>id</span>,<span style=color:#e6db74>&#34;/&#34;</span>,<span style=color:#ae81ff>8</span>)[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>peeringState</span><span style=color:#f92672>=</span><span style=color:#a6e22e>peerings</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>peeringState</span>,<span style=color:#a6e22e>useRemoteGateways</span><span style=color:#f92672>=</span><span style=color:#a6e22e>peerings</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>useRemoteGateways</span>,
</span></span><span style=display:flex><span><span style=color:#a6e22e>allowGatewayTransit</span><span style=color:#f92672>=</span><span style=color:#a6e22e>peerings</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>allowGatewayTransit</span>
</span></span></code></pre></div></p><p>Description :<br>Use this query to review the peering configuration of all Virtual Networks in scope</p></details></div><div><details><summary>Subnet details (NSG/UDR)</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> [<span style=color:#e6db74>&#39;type&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;microsoft.network/virtualnetworks&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//| project dynProperties=todynamic(properties)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#a6e22e>mv</span><span style=color:#f92672>-</span><span style=color:#a6e22e>expand</span> <span style=color:#a6e22e>subnetNames</span><span style=color:#f92672>=</span><span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>subnets</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>VNetName</span><span style=color:#f92672>=</span><span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>Subnet</span><span style=color:#f92672>=</span><span style=color:#a6e22e>subnetNames</span>.<span style=color:#a6e22e>name</span>,<span style=color:#a6e22e>AddressPrefix</span><span style=color:#f92672>=</span><span style=color:#a6e22e>subnetNames</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>addressPrefix</span>,
</span></span><span style=display:flex><span><span style=color:#a6e22e>RouteTable</span><span style=color:#f92672>=</span><span style=color:#a6e22e>split</span>(<span style=color:#a6e22e>subnetNames</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>routeTable</span>.<span style=color:#a6e22e>id</span>,<span style=color:#e6db74>&#34;/&#34;</span>,<span style=color:#ae81ff>8</span>)[<span style=color:#ae81ff>0</span>],
</span></span><span style=display:flex><span><span style=color:#a6e22e>NSG</span><span style=color:#f92672>=</span><span style=color:#a6e22e>split</span>(<span style=color:#a6e22e>subnetNames</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>networkSecurityGroup</span>.<span style=color:#a6e22e>id</span>,<span style=color:#e6db74>&#34;/&#34;</span>,<span style=color:#ae81ff>8</span>)[<span style=color:#ae81ff>0</span>],<span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;microsoft.network/subnets&#34;</span>
</span></span></code></pre></div></p><p>Description :<br>This query shows details about the subnets, Addresses, NSGs, UDRs.</p></details></div><div><details><summary>Display count of VMs by Azure location</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Resources</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.compute/virtualmachines&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>Total</span><span style=color:#f92672>=</span><span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Region</span><span style=color:#f92672>=</span><span style=color:#a6e22e>location</span>
</span></span></code></pre></div></p><p>Description :<br>Use this query to display a count of VMs by Azure location</p></details></div><div><details><summary>Display a count of VMs by OS Platform</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> [<span style=color:#e6db74>&#39;type&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;microsoft.compute/virtualmachines&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>osType</span><span style=color:#f92672>=</span><span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>storageProfile</span>.<span style=color:#a6e22e>osDisk</span>.<span style=color:#a6e22e>osType</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>osType</span>)
</span></span></code></pre></div></p><p>Description :<br>Use this query to display a count of VMs by OS Platform</p></details></div><div><details><summary>&lt;<em>ASG</em>> で指定したアプリケーション セキュリティ グループに紐づくネットワーク インターフェースを表示する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Resources</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;microsoft.network/networkinterfaces&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>isnotnull</span> (<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>ipConfigurations</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>applicationSecurityGroups</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>subscriptionId</span>, <span style=color:#a6e22e>resourceGroup</span>, <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>ASGs</span><span style=color:#f92672>=</span><span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>ipConfigurations</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>applicationSecurityGroups</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>mv</span><span style=color:#f92672>-</span><span style=color:#a6e22e>expand</span> <span style=color:#a6e22e>ASGs</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>subscriptionId</span>, <span style=color:#a6e22e>resourceGroup</span>, <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>ASG</span><span style=color:#f92672>=</span><span style=color:#a6e22e>ASGs</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ASG</span> <span style=color:#a6e22e>endswith</span> <span style=color:#e6db74>&#34;&lt;ASG&gt;&#34;</span>
</span></span></code></pre></div></p><p>Description :<br>NA</p></details></div><div class=section-index></div><div class="text-muted mt-5 pt-3 border-top">最終更新 June 13, 2022: <a href=https://github.com/tsubasaxZZZ/fta-hackon2022/commit/2a0a62fe3e1d45f1f066318a901412089b2e78b9>Copy from HackOn repository (2a0a62f)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/tsubasaxZZZ/fta-hackon2022 aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/fta-hackon2022/js/tabpane-persist.js></script>
<script src=/fta-hackon2022/js/main.min.9dedb4cb1735665f9e5f74805a267db6a8e16f899c40f6135e9be8787b1b8d0d.js integrity="sha256-ne20yxc1Zl+eX3SAWiZ9tqjhb4mcQPYTXpvoeHsbjQ0=" crossorigin=anonymous></script></body></html>