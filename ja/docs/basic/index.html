<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=ja class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.100.2"><link rel=alternate type=application/rss+xml href=https://azure.github.io/fta-kusto100knocks/ja/docs/basic/index.xml><meta name=robots content="index, follow"><link rel="shortcut icon" href=/fta-kusto100knocks/favicons/favicon.ico><link rel=apple-touch-icon href=/fta-kusto100knocks/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/fta-kusto100knocks/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/fta-kusto100knocks/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/fta-kusto100knocks/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/fta-kusto100knocks/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/fta-kusto100knocks/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/fta-kusto100knocks/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/fta-kusto100knocks/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/fta-kusto100knocks/favicons/android-192x192.png sizes=192x192><title>基本編 | KUSTO 100+ knocks</title><meta name=description content="KUSTO の基本となるフィルターやソート、日付に関するクエリを学習します。"><meta property="og:title" content="基本編"><meta property="og:description" content="KUSTO の基本となるフィルターやソート、日付に関するクエリを学習します。"><meta property="og:type" content="website"><meta property="og:url" content="https://azure.github.io/fta-kusto100knocks/ja/docs/basic/"><meta itemprop=name content="基本編"><meta itemprop=description content="KUSTO の基本となるフィルターやソート、日付に関するクエリを学習します。"><meta name=twitter:card content="summary"><meta name=twitter:title content="基本編"><meta name=twitter:description content="KUSTO の基本となるフィルターやソート、日付に関するクエリを学習します。"><link rel=preload href=/fta-kusto100knocks/scss/main.min.e42fbc313eb1919891fde4bb3bfbacc710b8890c78adce84a179ab0f4ff8977d.css as=style><link href=/fta-kusto100knocks/scss/main.min.e42fbc313eb1919891fde4bb3bfbacc710b8890c78adce84a179ab0f4ff8977d.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/fta-kusto100knocks/ja/><span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class=font-weight-bold>KUSTO 100+ knocks</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/fta-kusto100knocks/ja/docs/><span class=active>ドキュメント</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>日本語</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/fta-kusto100knocks/docs/basic/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>日本語</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/fta-kusto100knocks/docs/basic/>English</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-fta-kusto100knocksjadocs-li><a href=/fta-kusto100knocks/ja/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-fta-kusto100knocksjadocs><span>ドキュメント</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-fta-kusto100knocksjadocsbasic-li><a href=/fta-kusto100knocks/ja/docs/basic/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__section" id=m-fta-kusto100knocksjadocsbasic><span class=td-sidebar-nav-active-item>基本編</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-fta-kusto100knocksjadocsadvanced-li><a href=/fta-kusto100knocks/ja/docs/advanced/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-fta-kusto100knocksjadocsadvanced><span>応用編</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-fta-kusto100knocksjadocsportal-li><a href=https://portal.azure.com/#blade/Microsoft_Azure_Monitoring_Logs/DemoLogsBlade target=_blank rel=noopener class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-fta-kusto100knocksjadocsportal><span>デモワークスペースで試す🔎</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/Azure/fta-kusto100knocks//tree/main/content/ja/docs/Basic/_index.md class=td-page-meta--view target=_blank rel=noopener><i class="fa fa-file-alt fa-fw"></i> View page source</a>
<a href=https://github.com/Azure/fta-kusto100knocks//edit/main/content/ja/docs/Basic/_index.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> ページの編集</a>
<a href="https://github.com/Azure/fta-kusto100knocks//new/main/content/ja/docs/Basic/_index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> 子ページを作成</a>
<a href="https://github.com/Azure/fta-kusto100knocks//issues/new?title=%e5%9f%ba%e6%9c%ac%e7%b7%a8" class=td-page-meta--issue target=_blank rel=noopener><i class="fab fa-github fa-fw"></i> ドキュメントのissueを作成</a>
<a href=https://github.com/Azure/fta-kusto100knocks//issues/new class=td-page-meta--project-issue target=_blank rel=noopener><i class="fas fa-tasks fa-fw"></i> プロジェクトのissueを作成</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#使い方>使い方</a></li><li><a href=#用語>用語</a></li><li><a href=#リンク>リンク</a></li></ul><ul><li><a href=#目的の情報がどこにあるかを探す>目的の情報がどこにあるかを探す</a><ul><li><a href=#参考ドキュメント>参考ドキュメント</a></li></ul></li><li><a href=#日付を指定書式化する>日付を指定・書式化する</a><ul><li><a href=#参考ドキュメント-1>参考ドキュメント</a></li></ul></li><li><a href=#データを整える>データを整える</a></li><li><a href=#データを並び替え集約する>データを並び替え・集約する</a><ul><li><a href=#参考ドキュメント-2>参考ドキュメント</a></li></ul></li><li><a href=#可視化する>可視化する</a><ul><li><a href=#参考ドキュメント-3>参考ドキュメント</a></li></ul></li><li><a href=#テーブルを結合する>テーブルを結合する</a><ul><li><a href=#参考ドキュメント-4>参考ドキュメント</a></li></ul></li><li><a href=#データをフォーマットする>データをフォーマットする</a><ul><li><a href=#参考ドキュメント-5>参考ドキュメント</a></li></ul></li><li><a href=#その他>その他</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=https://azure.github.io/fta-kusto100knocks/ja/docs/>ドキュメント</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://azure.github.io/fta-kusto100knocks/ja/docs/basic/>基本編</a></li></ol></nav><div class=td-content><h1>基本編</h1><div class=lead>KUSTO の基本となるフィルターやソート、日付に関するクエリを学習します。</div><header class=article-meta></header><h1 id=はじめに>はじめに</h1><h2 id=使い方>使い方</h2><p>KQL を初めて使う方が KQL の書き方を身に着けるための演習用の問題集と回答、解説です。<br>実際の KQL を使う場面で頻繁に出現するコマンド（演算子、関数）を様々な角度からいろいろな使い方で実行することで、手でコマンドを覚えてもらうような利用方法を想定しています。</p><h2 id=用語>用語</h2><p>KQL では他のプログラム言語と同じように、各言語要素に対して名前がつけられています。この名前を覚えることは必須ではありませんが、学習効率を高めるためには意識しておいたほうが良い要素です。単に全てを「コマンド」とひとくくりにするのではなく、現在自分はどの要素が使っているのかを意識しながら KQL を書くと仕組みへの理解が速やかに深まります。</p><ul><li>演算子、オペレーター： 意味は同じです。</li><li>テーブル演算子： 最も多く使われるオペレーターです。テーブルの入力を受け付け、テーブルを出力します。処理の最初やパイプラインの次に現れる要素はテーブル演算子です。</li><li>スカラー演算子： 主にテーブル オペレーターの中で使われるオペレーターです。数値演算子、論理演算子、文字列演算子などがあり、テーブルの各行の特定の列の値などデータ処理を行います。後述の関数と区別がつきにくいのですが、 between と not-between はスカラー演算子です。</li><li>関数、ファンクション： 意味は同じで特定の処理結果を返します。入力値に対して処理を実施するものや、入力値を取らずに値を返すものがあります。スカラー演算子と似ているので注意してください。</li></ul><h2 id=リンク>リンク</h2><ul><li><p><a href=https://ms.portal.azure.com/#blade/Microsoft_Azure_Monitoring_Logs/DemoLogsBlade>Log Analytics DEMO workspace</a><br>サンプル データが用意されているデモ ワークスペースです。このページの KQL はこのデータに対して実行することを想定しています。</p></li><li><p><a href=https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/>Kusto Query Language</a><br>Azure Data Explorer の KQL のリファレンスです。Log Analytics ではこのなかの一部が実装されています。</p></li></ul><h1 id=基本の-kql>基本の KQL</h1><h2 id=目的の情報がどこにあるかを探す>目的の情報がどこにあるかを探す</h2><p>Azure Monitor のログを検索するためにはワークスペースにどのようなテーブルがあり、各テーブルはどのような構造のレコードを格納しているかを知る必要があります。ここでは基本的なオペレーターを使用して、目的の情報を含んだテーブルを見つけたり、よく使われる テーブルを題材に、探し出したテーブルに含まれるデータの構造を調べる方法を学習します。</p><div><details><summary>contoso を含むレコードの検索を行ってください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>search</span> <span style=color:#e6db74>&#34;contoso&#34;</span>
</span></span></code></pre></div></p><p>解説 :<br>search オペレーターはテーブルを指定しない場合、ワークスペース上の全てのテーブルに対して検索を行います。<br>一般的な KQL ではテーブルを指定してデータを取得しますが、目的のデータがどのテーブルに含まれているかわからない場合や、そもそもデータがワークスペースに存在するかどうかわからない場合などはsearch オペレーターを使用することができます。<br>大量のデータを検索する場合パフォーマンス上不利になるため、定期的に実行されるクエリなどでの多用は避けてください。
また、Kusto の実行環境によっては使えません。例えば Log Analytics では使うことができますが、Azure Resource Graph では使うことができません。</p></details></div><div><details><summary>contoso と retail を両方含むレコードの検索を行ってください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Prefered
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>search</span> <span style=color:#e6db74>&#34;contoso&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#e6db74>&#34;retail&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// NOT Prefered
</span></span></span><span style=display:flex><span><span style=color:#75715e>// search &#34;contoso&#34; | search &#34;retail&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>// search &#34;contoso&#34; | where Name contains &#34;retail&#34;
</span></span></span></code></pre></div></p><p>解説 :<br>search オペレーターは多くの結果を生成する可能性があり、パフォーマンスに影響を与えます。複数の条件を指定する必要がある場合には、１つの search オペレーターの条件に含めるようにしてください。複数の search オペレーターをパイプしたり、search オペレーターの結果を where でフィルタするような処理は、中間処理のために前の search オペレーターによって大きな結果セットが生成されます。これに対して複数の条件を指定した１つの search オペレーターはそれよりも小さな結果セットを生成します。</p></details></div><div><details><summary>大文字から始まる Contoso を含むレコードを表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>search</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span><span style=color:#a6e22e>case_sensitive</span> <span style=color:#e6db74>&#34;Contoso&#34;</span>
</span></span></code></pre></div></p><p>解説 :<br>search オペレーターは既定で大文字小文字を区別せずに検索を行いますが、kind 引数で明示的に動作を指定することができます。case_sensitive は大文字小文字を区別する指定です。</p></details></div><div><details><summary>Perf テーブルから contosohotels を含むレコードを表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>search</span> <span style=color:#66d9ef>in</span> (<span style=color:#a6e22e>Perf</span>) <span style=color:#e6db74>&#34;contosohotels&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// able to search piped Table
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>Perf</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>search</span> <span style=color:#e6db74>&#34;contosohotels&#34;</span>
</span></span></code></pre></div></p><p>解説 :<br>search オペレーターはテーブルを指定して検索を行うことができます。in 引数の値で検索対象とするテーブルを指定します。search オペレーターはパイプから受け取ったテーブルに対して検索を行うこともできます。</p></details></div><div><details><summary>SecurityEvent テーブルから contosohotels を含むレコードを表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>search</span> <span style=color:#66d9ef>in</span> (<span style=color:#a6e22e>SecurityEvent</span>) <span style=color:#e6db74>&#34;contosohotels&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// able to search piped Table
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>SecurityEvent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>search</span> <span style=color:#e6db74>&#34;contosohotels&#34;</span>
</span></span></code></pre></div></p><p>解説 :<br>この例は１つ前とほとんど同じです。同じ文字列を持つレコードが複数のテーブルに存在する可能性があることを理解するために用意しています。</p></details></div><div><details><summary>Alert テーブルと SecurityAlert テーブルから contosohotels を含むレコードを表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>search</span> <span style=color:#66d9ef>in</span> (<span style=color:#a6e22e>Alert</span>,<span style=color:#a6e22e>SecurityAlert</span>) <span style=color:#e6db74>&#34;contosohotels&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Other expression
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Need to combine multiple tables
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>Alert</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>union</span> <span style=color:#a6e22e>SecurityAlert</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>search</span> <span style=color:#e6db74>&#34;contosohotels&#34;</span>
</span></span></code></pre></div></p><p>解説 :<br>&ldquo;in&rdquo; 引数では複数のテーブルを指定することができます。この例では関連しそうな情報をもつテーブルをまたいで検索を行います。追加の例は KQL では複数のテーブルをパイプラインから渡すことができないため、予め複数のテーブルを &ldquo;union&rdquo; で接続しています。</p></details></div><div><details><summary><strong>[重要]ワークスペースにあるテーブルの一覧を表示してください</strong></summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>search</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>$table</span>
</span></span></code></pre></div></p><p>解説 :<br><p>KQL では通常テーブルを指定して検索を行うため、ワークスペースにどのようなテーブルがあるかを知る必要があります。
search オペレーターの検索結果には所属するテーブルを表す $table カラムが含まれるため、distinct オペレーターで一意の値を抽出することで、ワークスペースに含まれている全てのテーブルを一覧することができます。</p><p>存在するテーブルは UI から確認するのは非常に時間がかかるため、簡単にテーブル名だけを確認する方法としてこの例を挙げています。</p></p></details></div><div><details><summary>AzureDiagnostics テーブルのレコードを 10 個表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>take</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// limit and take is same 
</span></span></span><span style=display:flex><span><span style=color:#75715e>//AzureDiagnostics
</span></span></span><span style=display:flex><span><span style=color:#75715e>//| limit 10
</span></span></span></code></pre></div></p><p>解説 :<br>take オペレーターは素早くレコードの中身を確認したいときに使います。take は引数の数を上限としてレコードを取り出します。AzureDiagnostics は Azure 診断ログを保存していて非常に多くのレコードを含んでいるます。単純に AzureDiagnostics のテーブルを表示した場合、非常に長い実行時間が必要ですが take で結果を少数のレコードに絞ることですぐに結果を確認することができます。limit オペレーターも take と同じ動作をします。<br>take は毎回同じ結果が返るわけではありません。たとえば時刻順に最新のデータが取得されるわけではなく、データセットが変わらない場合でも前回実行時と結果が異なる場合があります。</p></details></div><div><details><summary>AzureDiagnostics テーブルの Category の一覧を表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>Category</span>
</span></span></code></pre></div></p><p>解説 :<br>AzureDiagnostics テーブルに含まれる診断ログには複数のリソースからのログから成り立っています。一般的に数十種類のリソースのログが集約されているため、どのようなリソースのログが含まれているかを把握することが重要です。<br>Category 列にはログを生成したリソースやログの種類のヒントが含まれているため、distinct オペレーターで Category の値を一覧にすることで、目的のログの有無を判断することが容易になります。</p></details></div><div><details><summary>AzureDiagnostics テーブルから ResourceType と Category の組み合わせの一覧を表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>ResourceType</span>,<span style=color:#a6e22e>Category</span>
</span></span></code></pre></div></p><p>解説 :<br>AzureDiagnostics の ResourceType にはログを生成したリソースの型が含まれるため、Category と組み合わせて distinct することで、どのリソースがどのカテゴリのログを生成しているか、わかりやすく表示することができます。</p></details></div><div><details><summary>AzureDiagnostics テーブルから ApplicationGatewayAccessLog を表示してください&lt;</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ApplicationGatewayAccessLog&#34;</span>
</span></span></code></pre></div></p><p>解説 :<br>where オペレーターは与えられた条件によってレコードを選択するフィルタです。AzureDiagnostics テーブルのログは種類ごとに異なる Category 列の値を持つため、Category 列の値でフィルタすることで、目的のリソースや目的の種類のログだけを選ぶことができます。</p></details></div><div><details><summary>AzureDiagnostics テーブルから ApplicationGatewayAccessLog をレコードの新しい順に表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ApplicationGatewayAccessLog&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#a6e22e>sort</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>desc</span> 
</span></span></code></pre></div></p><p>解説 :<br>フィルタされたログはクエリの実行者が期待する順序で並んでいるとは限りません。特に時系列に従って並べられていることを期待されることが多いですが、そうでない場合が多くあります。<br>sort オペレーターは指定した列の値によってレコードをソートします。既定では降順でソートを行います。この例では desc 引数を指定して明示的に降順に並び変えていますが、省略することもできます。</p></details></div><div><details><summary>AzureDiagnostics テーブルから ApplicationGatewayAccessLog をレコードの古い順に表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ApplicationGatewayAccessLog&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#a6e22e>sort</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>asc</span> 
</span></span></code></pre></div></p><p>解説 :<br>sort オペレーターで昇順にソートする場合には asc 引数を指定します。</p></details></div><div><details><summary>AzureDiagnostics テーブルのから ApplicationGatewayAccessLog をレコードの新しい順に 10 件表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ApplicationGatewayAccessLog&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#a6e22e>top</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>desc</span> 
</span></span></code></pre></div></p><p>解説 :<br>ソートされた結果からいくつかのレコードを取り出したい場合には top オペレーターを使用します。top は by 引数に指定された列の値でレコードをソートします。sort と同じく既定では降順にソートを行い、この例では明示的に desc を指定しています。</p></details></div><div><details><summary>AzureDiagnostics テーブルのから ApplicationGatewayAccessLog をレコードの古い順に 10 件表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Category</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ApplicationGatewayAccessLog&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#a6e22e>top</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>asc</span> 
</span></span></code></pre></div></p><p>解説 :<br>top オペレーターも sort と同様に asc 引数で昇順のソートを行うことができます。</p></details></div><div><details><summary>AzureMetrics テーブルのレコードを 10 個表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureMetrics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>take</span> <span style=color:#ae81ff>10</span>
</span></span></code></pre></div></p><p>解説 :<br>AzureMetrics テーブルは Azure リソースのメトリックを保持するテーブルです。リソースの診断設定でメトリックを有効にした場合、このテーブルに情報が保存されます。
Metric は Windows でいうところのパフォーマンス カウンターのようなもので、リソースの数値的な側面を計測するために利用します。</p></details></div><div><details><summary>AzureMetrics テーブルの MetricName の一覧を表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureMetrics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>MetricName</span>
</span></span></code></pre></div></p><p>解説 :<br>AzureMetrics テーブルには様々なリソースからメトリックが送られます。各メトリックは MetricName というフィールドを持ち、あるレコードがどのメトリックのデータであるかを見分けることができます。</p></details></div><div><details><summary>AzureMetrics テーブルの ResourceProvider と MetricName の組み合わせの一覧を表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureMetrics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>ResourceProvider</span>,<span style=color:#a6e22e>MetricName</span>
</span></span></code></pre></div></p><p>解説 :<br>メトリックの種類はかなり多いので、一覧する際には生成元となっているリソース プロバイダーの情報も利用すると見やすくなります。
distinct オペレーターで ResourceProvider と MetricName の一意な組み合わせを表示すると、各リソースプロバイダ―が生成するメトリックを整理することができます。</p></details></div><div><details><summary>AzureMetrics テーブルから Percentage CPU メトリックだけを表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>  <span style=color:#a6e22e>AzureMetrics</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>MetricName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Percentage CPU&#34;</span>
</span></span></code></pre></div></p><p>解説 :<br>特定のメトリックを表示するためには where オペレーターで任意の MetricName を指定します。</p></details></div><div><details><summary>AzureMetrics テーブルからコンピューター CH1-SQLVM12 の Percentage CPU を表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureMetrics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Resource</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;CH1-SQLVM12&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>MetricName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Percentage CPU&#34;</span>
</span></span></code></pre></div></p><p>解説 :<br>where オペレーターは複数の条件でレコードをフィルタすることができます。リソース名とメトリックを使用することで、特定のリソースの任意のメトリックだけを表示することができます。</p></details></div><div><details><summary>AzureActivity テーブルのレコードを 10 個表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureActivity</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>take</span> <span style=color:#ae81ff>10</span>
</span></span></code></pre></div></p><p>解説 :<br>この例はデモ ワークスペースでは動作しないかもしれませんので、お手持ちの Log Analytics ワークスペースでお試しください。
[参考：Log Analytics ワークスペースに送信する]Log Analytics ワークスペースに送信する(<a href=https://docs.microsoft.com/azure/azure-monitor/essentials/activity-log#send-to-log-analytics-workspace>https://docs.microsoft.com/azure/azure-monitor/essentials/activity-log#send-to-log-analytics-workspace</a>)
AzureActivity テーブルはリソースの変更や仮想マシンの起動といった、サブスクリプションに対する操作が記録されます。
変更作業の確認や、不必要なリソースに変更が行われていないかなどを調べることができます。</p></details></div><div><details><summary>AzureActivity テーブルで ResourceProviderValue と _ResourceId と OperationNameValue の組み合わせの一覧を表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureActivity</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>ResourceProviderValue</span>,<span style=color:#a6e22e>_ResourceId</span>, <span style=color:#a6e22e>OperationNameValue</span>
</span></span></code></pre></div></p><p>解説 :<br>_ResourceId はリソースの一意の識別子、ResourceProviderValue はリソース プロバイダーを表します。このクエリにより、各リソースにどのような操作が行われたかをプロバイダごとに整理して表示することができます。</p></details></div><div><details><summary>AzureActivity テーブルから操作を行ったユーザーとIP アドレスの一覧を表示する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>  <span style=color:#a6e22e>AzureActivity</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>Caller</span>,<span style=color:#a6e22e>CallerIpAddress</span>
</span></span></code></pre></div></p><p>解説 :<br>Caller は実行を行ったユーザー、CallerIpAddress はその際の操作元の IP アドレスです。意図しないユーザーや場所からの操作がないかどうかの確認に使うことができます。</p></details></div><div><details><summary>AzureActivity テーブルで Administrative カテゴリの操作を行ったユーザーの一覧</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureActivity</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>CategoryValue</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Administrative&#34;</span>   
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>Caller</span>
</span></span></code></pre></div></p><p>解説 :<br>管理作業は CategoryValue に Administrative という値を含みます。</p></details></div><div><details><summary>AzureActivity テーブルから管理作業に失敗したユーザーと IP アドレス、その操作対象となったリソースの一覧を表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureActivity</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ActivityStatusValue</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Failure&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>CategoryValue</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Administrative&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>distinct</span> <span style=color:#a6e22e>Caller</span>,<span style=color:#a6e22e>CallerIpAddress</span>, <span style=color:#a6e22e>_ResourceId</span>
</span></span></code></pre></div></p><p>解説 :<br>操作が失敗したエントリは ActivityStatusValue が Failure になります。このクエリにより管理業務を試みて失敗したユーザーを表示することができます。
失敗の理由は様々ですが、例えば CallerIpAddress が普段と異なる場合にはセキュリティ侵害を示唆している可能性があります。</p></details></div><h3 id=参考ドキュメント>参考ドキュメント</h3><ul><li>Azure リソース ログの共通およびサービス固有のスキーマ<ul><li><a href=https://docs.microsoft.com/azure/azure-monitor/essentials/resource-logs-schema>https://docs.microsoft.com/azure/azure-monitor/essentials/resource-logs-schema</a></li></ul></li><li>Azure アクティビティ ログのイベント スキーマ<ul><li><a href=https://docs.microsoft.com/azure/azure-monitor/essentials/activity-log-schema>https://docs.microsoft.com/azure/azure-monitor/essentials/activity-log-schema</a></li></ul></li><li>search 演算子<ul><li><a href="https://docs.microsoft.com/azure/data-explorer/kusto/query/searchoperator?pivots=azuredataexplorer">https://docs.microsoft.com/azure/data-explorer/kusto/query/searchoperator?pivots=azuredataexplorer</a></li></ul></li><li>distinct 演算子<ul><li><a href=https://docs.microsoft.com/azure/data-explorer/kusto/query/distinctoperator>https://docs.microsoft.com/azure/data-explorer/kusto/query/distinctoperator</a></li></ul></li><li>where 演算子<ul><li><a href=https://docs.microsoft.com/azure/data-explorer/kusto/query/whereoperator>https://docs.microsoft.com/azure/data-explorer/kusto/query/whereoperator</a></li></ul></li></ul><h2 id=日付を指定書式化する>日付を指定・書式化する</h2><p>Azure Monitor のログには、標準で定義されている列があり、データソースにより生成される時刻を示す <code>TimeGenerated</code> 列 によってログレコードの時刻が確認できます。<code>TimeGenerated</code> 列を使用することで、時刻を基にしたフィルターやレコードの件数を確認できます。</p><div><details><summary>現在の日付を UTC 時間で表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>print</span> <span style=color:#a6e22e>now</span>()
</span></span></code></pre></div></p><p>解説 :<br>現在の時刻は、<code>now()</code> 関数を使用すると取得できます。<code>now()</code> 関数を含む日付や時刻に関する関数が返す値は、<code>datetime</code>型となり Kusto では UTC 時間で表されます。<code>datetime</code>型のデータは、テーブルの時刻列(<code>TimeGenerated</code>)等で使用されており、フィルターやソートなどに使えます。</p></details></div><div><details><summary>特定の日時(&ldquo;2022年1月1日 12:00&rdquo;)を UTC 時間で表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>print</span> <span style=color:#a6e22e>datetime</span>(<span style=color:#e6db74>&#34;2022-01-01 12:00&#34;</span>)
</span></span></code></pre></div></p><p>解説 :<br><code>datetime</code>関数を使うと文字列を指定して日付や時刻を取得できます。<code>datetime</code> 関数の戻り値は<code>datetime</code>型として取得できます。</p></details></div><div><details><summary>特定の日時(&ldquo;2022年1月1日 12:00&rdquo;)を UTC+9 時間で表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>print</span> <span style=color:#a6e22e>datetime</span>(<span style=color:#e6db74>&#34;2022-01-01 12:00&#34;</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>9</span><span style=color:#a6e22e>h</span>
</span></span></code></pre></div></p><p>解説 :<br><code>datetime</code> 関数で返される <code>datetime</code> 型は UTC 時間で扱われます。タイムゾーンを意識した日付を扱う場合、ユーザーがタイムゾーンを指定する必要があります。UTC 時間を他のタイムゾーンに変更するには、その時間を<code>datetime</code>型の値に足します(もしくは引きます)。<code>datetime</code>型に対する足し引きは、<code>timespan</code>型の値を使います。このクエリのように、<code>9h</code>(9時間)や<code>30m</code>(30分)のような表記を使用します。</p></details></div><div><details><summary>現在の日時の 30 分前の日時を UTC+9 時間で表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>print</span> <span style=color:#a6e22e>datetime</span>(<span style=color:#e6db74>&#34;now&#34;</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>9</span><span style=color:#a6e22e>h</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>30</span><span style=color:#a6e22e>m</span>
</span></span></code></pre></div></p><p>解説 :<br><code>datetime</code> 型に対する足し引きを使うことで、過去や未来の時間を指定できます。<code>datetime</code>型に対する足し引きは、<code>timespan</code>型の値が使えます。</p></details></div><div><details><summary>UTC 時間で特定の期間(&ldquo;2022年1月1日"の 1 日のみ)のレコードを検索してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Alert</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>datetime</span>(<span style=color:#e6db74>&#34;2022-01-01 00:00:00&#34;</span>)..<span style=color:#ae81ff>1</span><span style=color:#a6e22e>day</span>)
</span></span></code></pre></div></p><p>解説 :<br>トラブルシューティング等で Azure の各サービスが出力するログを確認する際、特定の 1 日のログを確認したいことがあります。<code>TimeGenerated</code> 列に対して、<code>between</code>関数と<code>datetime</code>関数を組み合わせて使用することで時間の範囲を限定できます。</p></details></div><div><details><summary>UTC 時間で特定の期間(&ldquo;2022年1月1日 00時00分00秒"から"2022年1月2日 23時59分59秒"まで)のレコードを検索してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Alert</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>datetime</span>(<span style=color:#e6db74>&#34;2022-01-01 00:00:00&#34;</span>)..<span style=color:#a6e22e>datetime</span>(<span style=color:#e6db74>&#34;2022-01-02 23:59:59&#34;</span>))
</span></span></code></pre></div></p><p>解説 :<br><code>between</code>関数の範囲の始まりと終わりに、<code>datetime</code>関数を使用すると<code>datetime</code>関数に指定した日時を範囲とすることができます。</p></details></div><div><details><summary>UTC 時間で特定の期間(&ldquo;2022年1月1日 12時00分"から"2022年1月2日 12時59分"まで)のレコードを検索してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Alert</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>datetime</span>(<span style=color:#e6db74>&#34;2022-01-01 12:00&#34;</span>)..<span style=color:#a6e22e>datetime</span>(<span style=color:#e6db74>&#34;2022-01-02 12:59&#34;</span>))
</span></span></code></pre></div></p><p>解説 :<br><code>between</code>関数の範囲の始まりと終わりに、<code>datetime</code>関数を使用すると<code>datetime</code>関数に指定した日時を範囲とすることができます。<code>datetime</code>関数の引数にはさまざまな日付表現を指定できます。</p></details></div><div><details><summary>UTC 時間で今日(0時0分から今の時刻まで)のレコードを検索してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Alert</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>startofday</span>(<span style=color:#a6e22e>now</span>())
</span></span></code></pre></div></p><p>解説 :<br><code>TimeGenerated</code>型に対して比較演算子を使うことで、さまざまな時間の範囲の表現ができます。<code>startofday</code>関数は引数に指定された日付の開始日時を表す<code>datetime</code>型の値を返します。つまり、&ldquo;2022-01-01 12:34&rdquo; は、&ldquo;2022-01-01 0:00:00.000&rdquo; を表します。</p></details></div><div><details><summary>UTC 時間で今週(日曜日から今の時刻まで)のレコードを検索してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Alert</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>startofweek</span>(<span style=color:#a6e22e>now</span>())
</span></span></code></pre></div></p><p>解説 :<br><code>TimeGenerated</code>型に対して比較演算子を使うことで、さまざまな時間の範囲の表現ができます。<code>startofweek</code>関数は引数に指定された日付の週の開始日時を表す<code>datetime</code>型の値を返します。つまり、&ldquo;2022-01-01 12:34&rdquo; は、&ldquo;2021-12-26 0:00:00.000&rdquo; を表します。</p></details></div><div><details><summary>3日前から現時点までのレコードを検索してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Alert</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>3</span><span style=color:#a6e22e>day</span>)
</span></span></code></pre></div></p><p>解説 :<br><code>ago</code> 関数を使用すると現在の時刻から指定した日時前を表す<code>datetime</code>型の値を返します。つまり、<code>ago(3d)</code> は、現在の時刻から3日前の時刻を表します。日付以外にも、<code>1m</code>や<code>1h</code>などの時間単位を指定できます。</p></details></div><div><details><summary>過去30分間のレコードを検索してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Alert</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>30</span><span style=color:#a6e22e>m</span>)
</span></span></code></pre></div></p><p>解説 :<br>大きな時間範囲でクエリを実行すると実行時間が長くなります。Azure Firewall の診断ログや OS のパフォーマンスログ等大量にログが発生し得るテーブルを対象にする場合は、可能な限り時間範囲を絞った上でクエリを実行することを心がけてください。</p></details></div><div><details><summary>過去1.5時間のレコードを検索してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Alert</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>1.5</span><span style=color:#a6e22e>h</span>)
</span></span></code></pre></div></p><p>解説 :<br><code>timespan</code>型はさまざまな表現が出来ます。このクエリのように小数点を表すこともできます。</p></details></div><div><details><summary>2日前から3日前までのレコードを検索してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Alert</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#a6e22e>between</span> (<span style=color:#a6e22e>now</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>3</span><span style=color:#a6e22e>d</span>)..<span style=color:#ae81ff>1</span><span style=color:#a6e22e>day</span>)
</span></span></code></pre></div></p><p>解説 :<br><code>now</code>関数には、引数で<code>timespan</code>型のオフセットを指定できます。<code>between</code>関数と組み合わせるとさまざまな時間範囲の表現ができます。このクエリは <code>now(-3d)</code> を <code>ago(3d)</code> としても同じ結果になります。</p></details></div><div><details><summary>ローカルのタイムゾーン(UTC+9h)で今日のレコードを検索してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Alert</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>startofday</span>(<span style=color:#a6e22e>now</span>()) <span style=color:#f92672>-</span> <span style=color:#ae81ff>9</span><span style=color:#a6e22e>h</span>
</span></span></code></pre></div></p><p>解説 :<br><code>TimeGenerated</code>や<code>startofday</code>関数は、UTC時間で表現されます。従って、ローカル時間でフィルターする場合はタイムゾーンを考慮する必要があります。</p></details></div><div><details><summary>レコードの時刻と現在時刻の差をカラムとして追加してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Alert</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>30</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>timeAgo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>TimeGenerated</span> 
</span></span></code></pre></div></p><p>解説 :<br>アクセスログ等が含まれるテーブルにおいて、レコードの時刻と現在時刻の差を確認したいことがあります。<code>extend</code> と時刻関数を使用すると新たにカラムを追加し、時刻差を出力できます。</p></details></div><div><details><summary>1週間分(日曜日から今の時刻まで)のレコードを1日単位でグループ化し、1日当たりのレコード件数を表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>startofweek</span>(<span style=color:#a6e22e>now</span>())
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>startofday</span>(<span style=color:#a6e22e>TimeGenerated</span>)
</span></span></code></pre></div></p><p>解説 :<br><code>summarize</code>関数は時刻関数と組み合わされることがよくあります。アクセスログを集計する際等に利用すると便利です。</p></details></div><div><details><summary>過去30分のレコードを1分単位でグループ化し、1分当たりのレコード件数を表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>30</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>1</span><span style=color:#a6e22e>m</span>)
</span></span></code></pre></div></p><p>解説 :<br><code>summarize</code>関数と<code>bin</code>関数、時刻関数を組み合わせると日付に対してより柔軟な集計が出来ます。<code>bin</code>関数は<code>floor</code>関数(床関数)のエイリアスです。</p></details></div><h3 id=参考ドキュメント-1>参考ドキュメント</h3><ul><li>日付と時刻の操作<ul><li><a href="https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/samples?pivots=azuremonitor#date-and-time-operations">https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/samples?pivots=azuremonitor#date-and-time-operations</a></li></ul></li><li>Azure Monitor ログ内の標準列<ul><li><a href=https://docs.microsoft.com/ja-jp/azure/azure-monitor/logs/log-standard-columns#timegenerated>https://docs.microsoft.com/ja-jp/azure/azure-monitor/logs/log-standard-columns#timegenerated</a></li></ul></li><li>Azure Monitor Log Analytics のログ クエリのスコープと時間範囲<ul><li><a href=https://docs.microsoft.com/ja-jp/azure/azure-monitor/logs/scope#time-range>https://docs.microsoft.com/ja-jp/azure/azure-monitor/logs/scope#time-range</a></li></ul></li><li>datetime データ型<ul><li><a href=https://docs.microsoft.com/azure/data-explorer/kusto/query/scalar-data-types/datetime>https://docs.microsoft.com/azure/data-explorer/kusto/query/scalar-data-types/datetime</a></li></ul></li><li>Timespan データ型<ul><li><a href=https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/scalar-data-types/timespan>https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/scalar-data-types/timespan</a></li></ul></li></ul><h2 id=データを整える>データを整える</h2><p>Azure Monitor に保存されるログは生成元のリソースに応じて多様なフィールドをもち、多様な分析を行うことができます。一方、全てのフィールドを表示してしまう、テーブルに非常に多くの列が表示され、結果のデータセットは大きく、見づらくなってしまいます。ここではデータから必要なフィールドだけを選び出したり、フィールドの名前を変更して分析しやすくしたりなど、データを整型する方法について学習します。</p><div><details><summary>Heartbeat テーブルから過去 5 分以内にハートビートのあったコンピューターを表示してください、結果には Computer 列と TimeGenerated 列だけを含めてください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Heartbeat</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span> (<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>TimeGenerated</span>
</span></span></code></pre></div></p><p>解説 :<br>Heartbeat は Log Analytics エージェントによって送信される健全性の状態が記録されるテーブルです。
このテーブルを確認することで、特定の時刻のコンピューターの簡単な死活監視を行うことができます。<br><code>project</code> 演算子は結果セットの出力を特定の列に絞ることができます。このクエリでは出力結果を Computer 列と TimeGenerated 列に限定しています。出力される列の順番は <code>project</code> に渡された引数の順番になり、元のテーブルの順序ではなくなります。<br>Heartbeat 列はこの他にコンピューターの OS の情報や国などの地理情報も含んでいます。</p></details></div><div><details><summary>ハートビートを表示する際に、Computer 列を VM に、 TimeGenerated 列を TimeStamp という名前に変更してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Heartbeat</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span> (<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>VM</span><span style=color:#f92672>=</span><span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>TimeStamp</span><span style=color:#f92672>=</span><span style=color:#a6e22e>TimeGenerated</span>
</span></span></code></pre></div></p><p>解説 :<br><code>project</code> 演算子は出力列を選択する際に、列の名前を任意の文字列に変更することができます。
これにより出力列をわかりやすい名前に変更することができるほか、<code>join</code> など列名を参照するようなオペレーターをより簡単に扱うことができます。</p></details></div><div><details><summary>列名を変更する際にスペースを使った列名を指定してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Heartbeat</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span> (<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> [<span style=color:#e6db74>&#39;Virtual Machine&#39;</span>]<span style=color:#f92672>=</span><span style=color:#a6e22e>Computer</span>, [<span style=color:#e6db74>&#39;Time Stamp&#39;</span>]<span style=color:#f92672>=</span><span style=color:#a6e22e>TimeGenerated</span>
</span></span></code></pre></div></p><p>解説 :<br>見やすさのために列名にスペースを使いたいという場合がありますが、単純に &lsquo;変更後 列名&rsquo; = 変更前の列名 のように文字列をクォートで囲むだけではうまくいきません。<br>括弧 [] で文字列を囲むことで、変更後の列名にスペース入が入った文字列を使用することができます。</p></details></div><div><details><summary>式の利用 - TimeStamp に TimeGenerated に 5 時間を加算した値を設定してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Heartbeat</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span> (<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>VM</span><span style=color:#f92672>=</span><span style=color:#a6e22e>toupper</span>(<span style=color:#a6e22e>Computer</span>), <span style=color:#a6e22e>TimeStamp</span><span style=color:#f92672>=</span><span style=color:#a6e22e>datetime_add</span>(<span style=color:#e6db74>&#34;Hour&#34;</span>,<span style=color:#ae81ff>5</span>,<span style=color:#a6e22e>TimeGenerated</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// simplified expression
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>Heartbeat</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span> (<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>VM</span><span style=color:#f92672>=</span><span style=color:#a6e22e>toupper</span>(<span style=color:#a6e22e>Computer</span>), <span style=color:#a6e22e>TimeStamp</span><span style=color:#f92672>=</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span><span style=color:#a6e22e>h</span>
</span></span></code></pre></div></p><p>解説 :<br><code>project</code> 演算子は列を選択する際に計算式を適用することができます。このクエリでは datetime_add 関数を使用して、TimeGenerated に ５時間を加えたものを新しい列の値として設定しています。</p></details></div><div><details><summary>ハートビートを表示する際に VMUUID、MG、ManagementGroupName、SourceComputerId 列を出力しないようにしてください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Heartbeat</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span> (<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span><span style=color:#f92672>-</span><span style=color:#a6e22e>away</span> <span style=color:#a6e22e>VMUUID</span>, <span style=color:#a6e22e>MG</span>, <span style=color:#a6e22e>ManagementGroupName</span>, <span style=color:#a6e22e>SourceComputerId</span>
</span></span></code></pre></div></p><p>解説 :<br><code>project</code> 演算子は出力する列を選択しますが、<code>project-away</code> 演算子は出力しない列を選択します。出力から取り除きたい列が少ない場合にはこの演算子のほうが効率的かもしれません。</p></details></div><div><details><summary>Resource という文字列から始まる列を出力から取り除いてください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Heartbeat</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span> (<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span><span style=color:#f92672>-</span><span style=color:#a6e22e>away</span> <span style=color:#a6e22e>Resource</span><span style=color:#f92672>*</span>
</span></span></code></pre></div></p><p>解説 :<br><code>project-away</code> 演算子は特定のパターンを含む列を除外することができます。ワイルドカード文字を使用して、例えば ABC* を <code>project-away</code> に渡すと 「ABC から始まる列は除く」という意味になります。</p></details></div><div><details><summary>project-keep 演算子を使用して Resource という文字列から始まる列だけを出力してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Heartbeat</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span> (<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span><span style=color:#f92672>-</span><span style=color:#a6e22e>keep</span> <span style=color:#a6e22e>Resource</span><span style=color:#f92672>*</span>
</span></span></code></pre></div></p><p>解説 :<br><code>project-keep</code> 演算子は <code>project</code> と同じように列の選択を行います。結果の列の順序はテーブルの素の順序に従うという点が <code>project</code> との大きな違いです。</p></details></div><div><details><summary>project-reorder 演算子を使用して列を並び替えてください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Heartbeat</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span> (<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span><span style=color:#f92672>-</span><span style=color:#a6e22e>reorder</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>解説 :<br>出力結果の列は <code>project-reorder</code> 演算子で並び替えることができます。この例では全ての列を降順に並び替えています。</p></details></div><div><details><summary>project-rename 演算子を使用して列名を変更してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Heartbeat</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span> (<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span><span style=color:#f92672>-</span><span style=color:#a6e22e>rename</span> <span style=color:#a6e22e>VM</span><span style=color:#f92672>=</span><span style=color:#a6e22e>Compute</span>
</span></span></code></pre></div></p><p>解説 :<br><code>project-rename</code> 演算子は列名を変更することができます。<code>project</code> でも列名の変更はできますが、<code>project-rename</code> は他の列のフィルタリングには影響を与えずに、特定の列の名前だけを変更することができます。</p></details></div><div><details><summary>計算結果を持つ新しい列を追加してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Heartbeat</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Age</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>TimeGenerated</span>
</span></span></code></pre></div></p><p>解説 :<br><code>extend</code> 演算子は計算列を作成し、結果セットに追加します。この例では現在時刻とログが生成された時刻の差分を計算した新しい列を追加しています。</p></details></div><div><details><summary>新しい列を追加し、5 分より新しいレコードには✔️を、古いレコードには❌を設定してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Heartbeat</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>LastReported</span><span style=color:#f92672>=</span><span style=color:#a6e22e>now</span>()<span style=color:#f92672>-</span><span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>TimeGenerated</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>,<span style=color:#a6e22e>TimeGenerated</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>RecentHeartBeat</span><span style=color:#f92672>=</span><span style=color:#a6e22e>iff</span>(<span style=color:#a6e22e>TimeGenerated</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>),<span style=color:#e6db74>&#39;✔️ &#39;</span>, <span style=color:#e6db74>&#39;❌ &#39;</span>)
</span></span></code></pre></div></p><p>解説 :<br><code>iif</code> 関数は最初の引数が true であれば ２番目の引数を、false であれば 3 番目の引数の結果を返します。２番目や３番目の引数には計算式を持つこともでき、条件に応じてより複雑な処理を行うこともできます。</p></details></div><h2 id=データを並び替え集約する>データを並び替え・集約する</h2><p>ログは特定の目的のために並び替えを行ったり、データの特定の側面にフォーカスするために集計をする必要があります。ここでは <code>summarize</code> 演算子と、集計関数を使用して、ログやメトリックに含まれる情報を整理する方法について学習します。</p><div><details><summary>summarize 演算子を使用して、InsightsMetrics テーブルに収集されているパフォーマンス カウンターの数をコンピューターごとに集計してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>InsightsMetrics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>Namespace</span>, <span style=color:#a6e22e>Name</span>
</span></span></code></pre></div></p><p>解説 :<br><code>summarize</code> 演算子は入力されたテーブルを様々な形に集計することができます。集計の種類は引数の集計関数で指定することができ、<code>count()</code> は単純にレコードの数を数える集計関数です。
集計の単位は by に続く列名で指定することができ、この例では Computer と Namespace の組み合わせに対して集計を行っています。<br>InsightsMetrics は (従来の Log Analytics エージェントによって収集される Perf ではなく) VM Insights によって収集されるパフォーマンス カウンターを格納するためのテーブルです。</p></details></div><div><details><summary>コンピューターごとに何種類のパフォーマンス カウンターがあるかを集計してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>InsightsMetrics</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>dcount</span>(<span style=color:#a6e22e>Name</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>
</span></span></code></pre></div></p><p>解説 :<br><code>dcount()</code> 関数は与えられた列の中で、ユニークな値が何個あるかを計算する集計関数です。この例ではコンピューターから収集されるパフォーマンス カンターの名前ですが、ユーザーがログインしている場所の数、コンピューターが接続したことのある IP の数など、様々な集計に使うことができます。</p></details></div><div><details><summary>UtilizationPercentage の平均値をコンピューターごとに集計してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>InsightsMetrics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;UtilizationPercentage&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>Val</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>
</span></span></code></pre></div></p><p>解説 :<br><code>summarize</code> 演算子に与える集計関数を変えることで集計方法が変わります。<code>avg()</code> 関数に対象とする列名を与えることで、列の値の平均値を計算することができます。</p></details></div><div><details><summary>UtilizationPercentage の最大値をコンピューターごとに集計してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>InsightsMetrics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;UtilizationPercentage&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>max</span>(<span style=color:#a6e22e>Val</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>
</span></span></code></pre></div></p><p>解説 :<br><code>max()</code> 関数に対象とする列名を与えることで、列の値の最大値を計算することができます。</p></details></div><div><details><summary>UtilizationPercentage の最小値をコンピューターごとに集計してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>InsightsMetrics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;UtilizationPercentage&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>min</span>(<span style=color:#a6e22e>Val</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>
</span></span></code></pre></div></p><p>解説 :<br><code>min()</code> 関数に対象とする列名を与えることで、列の値の最小値を計算することができます。</p></details></div><div><details><summary>UtilizationPercentage の平均値の 1 時間ごとの推移をコンピューターごとに集計してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>InsightsMetrics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;UtilizationPercentage&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>Val</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>1</span><span style=color:#a6e22e>h</span>)
</span></span></code></pre></div></p><p>解説 :<br><code>summarize</code> 演算子の集計は複数の列に対して行うことができます。この例は非常によく使われるパターンで、注目したいリソースと時間に対して集計を行うことで、特定のリソースのふるまいを時系列で集計することができます。
単純に TimeGenerated を使った場合には単位が細かすぎてしまうので、<code>bin()</code> 関数を使って丸めるのが一般的です。例では 1 時間単位に丸めていますが、10 分 (10m) 、100 秒 (100s) といった丸め方もできます。</p></details></div><div><details><summary>容量の少ないディスクを 10 個表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>InsightsMetrics</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Namespace</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;LogicalDisk&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>Name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;FreeSpacePercentage&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>DiskInstance</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>parse_json</span>(<span style=color:#a6e22e>Tags</span>).[<span style=color:#e6db74>&#34;vm.azm.ms/mountId&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>FreeDiskSpace</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>Val</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>DiskInstance</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>FreeDiskSpace</span> <span style=color:#a6e22e>asc</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>take</span> <span style=color:#ae81ff>10</span>
</span></span></code></pre></div></p><p>解説 :<br>ディスクの空き容量を表すパフォーマンス カウンターの名前は <code>FreeSpacePercentage</code> です。この例では集計した時間帯の <code>FreeSpacePercentage</code> の平均値が最も小さいディスクを 10 個選択しています。<br>InsightsMetrics テーブルではボリュームのラベルは直接値としては列に現れず、JSON データとして Tags 列に含まれています。
このため <code>parse_json</code> 関数を使用して Tags 列を解析して取得したボリュームのラベルの値を <code>extend</code> 演算子により新たな列の値として設定しています。</p></details></div><div><details><summary>空き容量が閾値 (20 %) 以下のロジックディスクを表示してください</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>threshold</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>InsightsMetrics</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Namespace</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;LogicalDisk&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>Name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;FreeSpacePercentage&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>DiskInstance</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>parse_json</span>(<span style=color:#a6e22e>Tags</span>).[<span style=color:#e6db74>&#34;vm.azm.ms/mountId&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>FreeDiskSpace</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>Val</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>DiskInstance</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>FreeDiskSpace</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>threshold</span>
</span></span></code></pre></div></p><p>解説 :<br>空き容量が一定の値以下のディスクを表示しています。この例では閾値となる数値を threshold という名前の変数に格納しています。<br>変数を使用することで変更、再利用が容易で、わかりやすいクエリにすることができます。</p></details></div><div><details><summary>Count the number of events collected per computer</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Event</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>
</span></span></code></pre></div></p><p>解説 :<br>コンピュータごとに収集したイベント数をカウントする</p></details></div><div><details><summary>コンピュータごとに収集されたイベント数を時系列でカウントする</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Event</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>1</span><span style=color:#a6e22e>h</span>), <span style=color:#a6e22e>Computer</span>
</span></span></code></pre></div></p><p>解説 :<br>コンピュータごとに収集したイベント数を1時間のタイムバケットに集約してカウントする</p></details></div><div><details><summary>コンピュータの収集イベントトップ10を表示</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Event</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>
</span></span></code></pre></div></p><p>解説 :<br>コンピュータごとに収集したイベント数をカウントし、イベントを収集している上位10台のコンピュータを表示します。</p></details></div><div><details><summary>全マシンのトッププロセスを表示</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Perf</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ObjectName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Process&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>CounterName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;% Processor Time&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>AverageValue</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>CounterValue</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>InstanceName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>InstanceName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>AverageValue</span>
</span></span></code></pre></div></p><p>解説 :<br>全サーバーにおけるプロセスの <code>% Processor</code> をまとめ、上位10位までをリストアップしてください。</p></details></div><h3 id=参考ドキュメント-2>参考ドキュメント</h3><ul><li>summarize 演算子<ul><li><a href=https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/summarizeoperator>https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/summarizeoperator</a></li></ul></li><li>集計関数<ul><li><a href=https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/aggregation-functions>https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/aggregation-functions</a></li></ul></li></ul><h2 id=可視化する>可視化する</h2><p>Azure Monitor ではクエリで取得したデータセットのテーブルを見やすく表示することができます。ここでは <code>render</code> 演算子を使用して、データセットを棒グラフや折れ線グラフとして可視化する方法を学習します。</p><div><details><summary>Show event count as a chart</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>SecurityEvent</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>EventCount</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>EventID</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>EventCount</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>columnchart</span> 
</span></span></code></pre></div></p><p>Description :<br>Use the render operator to draw a chart of the top 10 Security Events</p></details></div><div><details><summary>Show event count distribution over time</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>SecurityEvent</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>EventCount</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>1</span><span style=color:#a6e22e>h</span>), <span style=color:#a6e22e>Computer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span> 
</span></span></code></pre></div></p><p>Description :<br>Use the render operator to draw a chart of the security event distribution over time, per computer</p></details></div><div><details><summary>Show CPU Utilisation over time</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>InsightsMetrics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Namespace</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Processor&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>Name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;UtilizationPercentage&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>AverageValue</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>Val</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>1</span><span style=color:#a6e22e>h</span>), <span style=color:#a6e22e>Computer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span> <span style=color:#66d9ef>with</span> (<span style=color:#a6e22e>ycolumns</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>series</span><span style=color:#f92672>=</span> <span style=color:#a6e22e>AverageValue</span>)
</span></span></code></pre></div></p><p>Description :<br>Use the render operator to draw a chart of the processor utilisation over time with aggregations into 1 hour averages, broken down by computer</p></details></div><div><details><summary>Show Memory Utilisation over time</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>InsightsMetrics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Namespace</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Memory&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>Name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;AvailableMB&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>memorySizeMB</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>toint</span>(<span style=color:#a6e22e>parse_json</span>(<span style=color:#a6e22e>Tags</span>).[<span style=color:#e6db74>&#34;vm.azm.ms/memorySizeMB&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>PercentageUsed</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span><span style=color:#f92672>-</span>(<span style=color:#a6e22e>Val</span><span style=color:#f92672>/</span><span style=color:#a6e22e>memorySizeMB</span>)<span style=color:#f92672>*</span><span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>AverageValue</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>PercentageUsed</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>30</span><span style=color:#a6e22e>m</span>), <span style=color:#a6e22e>Computer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>timechart</span>
</span></span></code></pre></div></p><p>Description :<br>Use the render operator to draw a chart of the percentage used memory over time with aggregations into 30 minute averages, broken down by computer. The memory used percentage is a calculated column, as only available memory in MB and total memory in MB is presented</p></details></div><div><details><summary>Show Pie graph of sources collected in Azure Diagnostics</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>ResourceProvider</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>piechart</span> 
</span></span></code></pre></div></p><p>Description :<br>Use the render operator to draw a chart of the different sources collected into Azure Diagnostics</p></details></div><div><details><summary>Show Pie graph of current missing updates in Update Management</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Update</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>UpdateState</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Needed&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>OSType</span><span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;Linux&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span>  <span style=color:#a6e22e>arg_max</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#f92672>*</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Title</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> (<span style=color:#a6e22e>Classification</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Security Updates&#34;</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>Classification</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Critical Updates&#34;</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>Classification</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Definition Updates&#34;</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>Classification</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Others&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>MissingUpdates</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Classification</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>MissingUpdates</span> <span style=color:#a6e22e>desc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>piechart</span> 
</span></span></code></pre></div></p><p>Description :<br>Use the render operator to draw a chart of the missing update count in Update Management</p></details></div><div><details><summary>Show Area Chart of Logic Apps Run Latency</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureMetrics</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ResourceProvider</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;MICROSOFT.LOGIC&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>MetricName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;RunLatency&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>AverageLatency</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>avg</span>(<span style=color:#a6e22e>Average</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>bin</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#ae81ff>10</span><span style=color:#a6e22e>m</span>), <span style=color:#a6e22e>Resource</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>render</span> <span style=color:#a6e22e>areachart</span>
</span></span></code></pre></div></p><p>Description :<br>Use the render operator to draw a chart of run latency for logic apps</p></details></div><h3 id=参考ドキュメント-3>参考ドキュメント</h3><ul><li>render 演算子<ul><li><a href="https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/renderoperator?pivots=azuremonitor">https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/renderoperator?pivots=azuremonitor</a></li></ul></li></ul><h2 id=テーブルを結合する>テーブルを結合する</h2><p>数のテーブルに分散した特定のリソースの情報を分析したいようなケースではテーブルを結合することができます。よく似た（あるいは全く同じ性質の）テーブル同士を結合したデータセットに対して分析を行ったり、あるいはリソースへの追加となる情報を持つテーブルから特定の情報を選び出し、データをエンリッチすることができます。ここではテーブルを結合するための演算子を学習します。</p><div><details><summary>Join VMComputer and InsightMetrics to get last heartbeat per computer</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMComputer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>OperatingSystemFullName</span>, <span style=color:#a6e22e>_ResourceId</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> (
</span></span><span style=display:flex><span><span style=color:#a6e22e>InsightsMetrics</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Heartbeat&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>LastHeartbeat</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>arg_max</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#f92672>*</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>_ResourceId</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>LastHeartbeat</span>, <span style=color:#a6e22e>_ResourceId</span>
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>_ResourceId</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span><span style=color:#f92672>-</span><span style=color:#a6e22e>away</span> <span style=color:#a6e22e>_ResourceId1</span>
</span></span></code></pre></div></p><p>Description :<br>Use the join operator to join two tables to see last heartbeat per computer</p></details></div><div><details><summary>Join two queries from the SecurityEvents table together to determine logon duration</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>SecurityEvent</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>EventID</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>4624</span>		<span style=color:#75715e>// sign-in events
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>Account</span>, <span style=color:#a6e22e>TargetLogonId</span>, <span style=color:#a6e22e>LogonTime</span><span style=color:#f92672>=</span><span style=color:#a6e22e>TimeGenerated</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>kind</span><span style=color:#f92672>=</span> <span style=color:#a6e22e>inner</span> (
</span></span><span style=display:flex><span><span style=color:#a6e22e>SecurityEvent</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>EventID</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>4634</span>		<span style=color:#75715e>// sign-out events
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>TargetLogonId</span>, <span style=color:#a6e22e>LogoffTime</span><span style=color:#f92672>=</span><span style=color:#a6e22e>TimeGenerated</span>
</span></span><span style=display:flex><span>    ) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>TargetLogonId</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>Duration</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>LogoffTime</span><span style=color:#f92672>-</span><span style=color:#a6e22e>LogonTime</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span><span style=color:#f92672>-</span><span style=color:#a6e22e>away</span> <span style=color:#a6e22e>TargetLogonId1</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>top</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Duration</span> <span style=color:#a6e22e>desc</span>
</span></span></code></pre></div></p><p>Description :<br>Use the join operator to join two queries from the SecurityEvents table together to determine logon duration</p></details></div><div><details><summary>Join Heartbeat table with Update Management table to view update status</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Update</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>OSType</span><span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;Linux&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>Optional</span><span style=color:#f92672>==</span><span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>hint</span>.<span style=color:#a6e22e>strategy</span><span style=color:#f92672>=</span><span style=color:#a6e22e>partitioned</span> <span style=color:#a6e22e>arg_max</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#f92672>*</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>,<span style=color:#a6e22e>SourceComputerId</span>,<span style=color:#a6e22e>UpdateID</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>UpdateState</span><span style=color:#f92672>=~</span><span style=color:#e6db74>&#34;Needed&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>Approved</span><span style=color:#f92672>!=</span><span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> (<span style=color:#a6e22e>UpdateSummary</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>arg_max</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#f92672>*</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>OsVersion</span>, <span style=color:#a6e22e>RestartPending</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>OsVersion</span>, <span style=color:#a6e22e>RestartPending</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>on</span> <span style=color:#a6e22e>Computer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> ( <span style=color:#a6e22e>Heartbeat</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>LastHeartBeat</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>arg_max</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#f92672>*</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>LastHeartBeat</span>, <span style=color:#a6e22e>Computer</span>
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>Computer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>arg_max</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#f92672>*</span>), <span style=color:#a6e22e>SecurityUpdates</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>countif</span>(<span style=color:#a6e22e>Classification</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Security Updates&#34;</span>), <span style=color:#a6e22e>CriticalUpdates</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>countif</span>(<span style=color:#a6e22e>Classification</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Critical Updates&#34;</span>), <span style=color:#a6e22e>DefinitionUpdates</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>countif</span>(<span style=color:#a6e22e>Classification</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Definition Updates&#34;</span>), <span style=color:#a6e22e>ServicePacks</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>countif</span>(<span style=color:#a6e22e>Classification</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Service Packs&#34;</span>), <span style=color:#a6e22e>Others</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>countif</span>(<span style=color:#a6e22e>Classification</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;Security Updates&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>Classification</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;Critical Updates&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>Classification</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;Definition Updates&#34;</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>Classification</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;Service Packs&#34;</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>OsVersion</span>, <span style=color:#a6e22e>RestartPending</span>, <span style=color:#a6e22e>ResourceId</span>, <span style=color:#a6e22e>LastHeartBeat</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>ResourceId</span>, <span style=color:#a6e22e>OsVersion</span>, <span style=color:#a6e22e>RestartPending</span>, <span style=color:#a6e22e>LastHeartBeat</span>, <span style=color:#a6e22e>SecurityUpdates</span>, <span style=color:#a6e22e>CriticalUpdates</span>, <span style=color:#a6e22e>DefinitionUpdates</span>, <span style=color:#a6e22e>ServicePacks</span>, <span style=color:#a6e22e>Others</span>
</span></span></code></pre></div></p><p>Description :<br>Use the join operator to join Heartbeat table to Update Management table to view update status, last heartbeat and reboot status</p></details></div><div><details><summary>Join Heartbeat table with syslog table to get count of syslog events</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Heartbeat</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>arg_max</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#f92672>*</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>_ResourceId</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>join</span> (
</span></span><span style=display:flex><span><span style=color:#a6e22e>Syslog</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>SyslogCount</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>_ResourceId</span>
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>_ResourceId</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>_ResourceId</span>, <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>ComputerIP</span>, <span style=color:#a6e22e>OSName</span>, <span style=color:#a6e22e>ResourceGroup</span>, <span style=color:#a6e22e>SubscriptionId</span>, <span style=color:#a6e22e>SyslogCount</span>
</span></span></code></pre></div></p><p>Description :<br>Use the join operator to join Heartbeat table to syslog table to get a count of events per computer</p></details></div><h3 id=参考ドキュメント-4>参考ドキュメント</h3><ul><li>union 演算子<ul><li><a href="https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/unionoperator?pivots=azuremonitor">https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/unionoperator?pivots=azuremonitor</a></li></ul></li><li>join 演算子<ul><li><a href="https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/joinoperator?pivots=azuremonitor">https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/joinoperator?pivots=azuremonitor</a></li></ul></li></ul><h2 id=データをフォーマットする>データをフォーマットする</h2><p>Azure Monitor に保存されるログは、全部が分析のために最適な形になっているわけではありません。具体的にはログの生成元が XML や JSON、あるいは構造化されていないただのテキストデータを生成していて、そのデータは複数のフィールドとして加工されずにどこか一つのフィールドに格納されていることがあります。ここでは、そのようなフィールドを扱いやすく加工するための方法について学習します。</p><div><details><summary>リソースID を解析する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>AzureDiagnostics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>ResourceType</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;SERVERS/DATABASES&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>ResourceId</span> <span style=color:#66d9ef>with</span> <span style=color:#f92672>*</span> <span style=color:#e6db74>&#34;/RESOURCEGROUPS/&#34;</span> <span style=color:#a6e22e>ResourceGroupName</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>*</span> <span style=color:#e6db74>&#34;/DATABASES/&#34;</span> <span style=color:#a6e22e>Databasename</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#a6e22e>Category</span>, <span style=color:#a6e22e>OperationName</span>, <span style=color:#a6e22e>ResourceGroupName</span>, <span style=color:#a6e22e>Databasename</span> 
</span></span></code></pre></div></p><p>解説 :<br><code>parse</code> オペレーターを使用して、リソース ID フィールドからリソースグループとリソー ス名を抽出します。</p></details></div><div><details><summary>syslogの文字列を解析する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Syslog</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>Facility</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;authpriv&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>parse</span> <span style=color:#a6e22e>SyslogMessage</span> <span style=color:#66d9ef>with</span> <span style=color:#f92672>*</span> <span style=color:#e6db74>&#34;(&#34;</span> <span style=color:#a6e22e>session</span> <span style=color:#e6db74>&#34;):&#34;</span> <span style=color:#f92672>*</span> <span style=color:#e6db74>&#34;user&#34;</span> <span style=color:#a6e22e>UserName</span>
</span></span></code></pre></div></p><p>解説 :<br>ログの文字列エントリから一貫して文字列値を抽出するには、<code>parse</code> コマンドを使用します。</p></details></div><div><details><summary>クエリから特定の列を返す</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>VMComputer</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>arg_max</span>(<span style=color:#a6e22e>TimeGenerated</span>, <span style=color:#f92672>*</span>) <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>Computer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>IPAddress</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>Ipv4Addresses</span>[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>extend</span> <span style=color:#a6e22e>DNSNAme</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>(<span style=color:#a6e22e>DnsNames</span>[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>Computer</span>, <span style=color:#a6e22e>BootTime</span>, <span style=color:#a6e22e>IPAddress</span>, <span style=color:#a6e22e>DNSNAme</span>, <span style=color:#a6e22e>OperatingSystemFullName</span>, <span style=color:#a6e22e>PhysicalMemoryMB</span>, <span style=color:#a6e22e>Cpus</span>, <span style=color:#a6e22e>CpuSpeed</span>, <span style=color:#a6e22e>AzureResourceGroup</span>, <span style=color:#a6e22e>AzureSubscriptionId</span>
</span></span></code></pre></div></p><p>解説 :<br><code>project</code> 演算子を使用して、クエリの列を特定することができます。</p></details></div><div><details><summary>クエリ結果から特定のカラムを除外する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>SecurityEvent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>summarize</span> <span style=color:#a6e22e>count</span>() <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>EventID</span>, <span style=color:#a6e22e>Activity</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span><span style=color:#f92672>-</span><span style=color:#a6e22e>away</span> <span style=color:#a6e22e>EventID</span>
</span></span></code></pre></div></p><p>解説 :<br>クエリ結果から特定のカラムを除外するには、<code>project-away </code>演算子を使用します。</p></details></div><h3 id=参考ドキュメント-5>参考ドキュメント</h3><ul><li>parse 演算子<ul><li><a href=https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/parseoperator>https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/parseoperator</a></li></ul></li></ul><h2 id=その他>その他</h2><p>ここでは複雑なクエリを書く際に頻繁に使われる記法や、必要とされる頻度は多くないものの特定のな問題を効率よく解決するための KQL を紹介します。</p><p>色々な分析の中で</p><div><details><summary>サービスタグに含まれる IP プレフィックスの一覧を取得する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>serviceName</span><span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;VirtualDesktop&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>externaldata</span>(<span style=color:#a6e22e>changeNumber</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>, <span style=color:#a6e22e>cloud</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>, <span style=color:#a6e22e>values</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>dynamic</span>)[<span style=color:#e6db74>&#34;https://download.microsoft.com/download/7/1/D/71D86715-5596-4529-9B13-DA13A5DE5B63/ServiceTags_Public_20220228.json&#34;</span>]  <span style=color:#66d9ef>with</span>(<span style=color:#a6e22e>format</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;multijson&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>mv</span><span style=color:#f92672>-</span><span style=color:#a6e22e>expand</span> <span style=color:#a6e22e>values</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>values</span> <span style=color:#a6e22e>contains</span> <span style=color:#a6e22e>serviceName</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>mv</span><span style=color:#f92672>-</span><span style=color:#a6e22e>expand</span> <span style=color:#a6e22e>values</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>addressPrefixes</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#a6e22e>project</span> <span style=color:#a6e22e>addressPrefixes</span><span style=color:#f92672>=</span> <span style=color:#a6e22e>tostring</span>( <span style=color:#a6e22e>values_properties_addressPrefixes</span>)
</span></span></code></pre></div></p><p>解説 :<br><p>Azure のサービスで使われる IP アドレスはサービスタグとして公開されていて、インターネット上から参照することができます。<br><code>externaldata</code> オペレーターは外部のストレージ アカウントから CSV や JSON などで記述されたデータを取得します。このサンプルでは直接インターネット上からファイルを取得していますが、SAS を使用してあアクセスが制御されているストレージ アカウントからデータを取得することができます。</p><p>注意 - ファイル名 ServiceTags_Public_YYYYMMDD.json は IP リストの更新に伴い変更されるため、次のページから常に新しいファイルを参照する必要があります。<br><a href="https://www.microsoft.com/en-us/download/details.aspx?id=56519">Azure IP Ranges and Service Tags – Public Cloud</a></p><p>KQL で参照するファイルは自身で管理するストレージアカウントに配置し、リストが更新されるたびに自動的にストレージ アカウントのファイルが更新されるような仕組みを考えてください。<br><a href=https://techcommunity.microsoft.com/t5/microsoft-sentinel-blog/using-external-data-sources-to-enrich-network-logs-using-azure/ba-p/1450345>Using external data sources to enrich network logs using Azure storage and KQL</a></p></p></details></div><div><details><summary>日付や文字列などの計算結果をクイックに確認する</summary><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>print</span> <span style=color:#a6e22e>now</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>print</span> <span style=color:#a6e22e>now</span>(<span style=color:#ae81ff>9</span><span style=color:#a6e22e>h</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>print</span> <span style=color:#a6e22e>ago</span>(<span style=color:#ae81ff>9</span><span style=color:#a6e22e>h</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>print</span> <span style=color:#a6e22e>substring</span>(<span style=color:#e6db74>&#34;hello KQL world&#34;</span>,<span style=color:#ae81ff>6</span>,<span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>print</span>  <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>print</span> <span style=color:#a6e22e>iif</span>(<span style=color:#66d9ef>true</span>, <span style=color:#ae81ff>100</span> , <span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>print</span> <span style=color:#a6e22e>iif</span>(<span style=color:#66d9ef>false</span>, <span style=color:#ae81ff>100</span> , <span style=color:#ae81ff>200</span>)
</span></span></code></pre></div></p><p>解説 :<br><code>print</code> オペレーターはスカラー式（複数の行を持つテーブルを作らない計算）を実行します。時刻や文字列の計算を長いクエリに含める際に、予め部分的に計算結果を確認しておきたいような場合に便利です。</p></details></div><p>参考ドキュメント</p><ul><li>externaldata 演算子<ul><li><a href="https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/externaldata-operator?pivots=azuremonitor">https://docs.microsoft.com/ja-jp/azure/data-explorer/kusto/query/externaldata-operator?pivots=azuremonitor</a></li></ul></li></ul><div class=section-index></div><div class="text-muted mt-5 pt-3 border-top">最終更新 June 13, 2022: <a href=https://github.com/Azure/fta-kusto100knocks//commit/2a0a62fe3e1d45f1f066318a901412089b2e78b9>Copy from HackOn repository (2a0a62f)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/Azure/fta-kusto100knocks/ aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/fta-kusto100knocks/js/tabpane-persist.js></script>
<script src=/fta-kusto100knocks/js/main.min.0596c1a2ee6a011fa4a9725803a8a682f1135c2434dda849d266d2523b82f434.js integrity="sha256-BZbBou5qAR+kqXJYA6imgvETXCQ03ahJ0mbSUjuC9DQ=" crossorigin=anonymous></script></body></html>